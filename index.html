<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penerjemah Hoshi (Ditingkatkan)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tesseract.js untuk OCR pada gambar -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <!-- Firebase SDK - Diperbarui ke versi modular terbaru -->
    <script type="module">
        // Mengimpor fungsi yang diperlukan dari SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp, onSnapshot, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // KONFIGURASI FIREBASE ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyCybId57osSubD6X5wA0V780dtMjgA69o8", // Kunci API Firebase yang benar
            authDomain: "translator-hosh.firebaseapp.com",
            projectId: "translator-hoshi",
            storageBucket: "translator-hoshi.appspot.com",
            messagingSenderId: "...", 
            appId: "..." 
        };

        // Inisialisasi Firebase
        let app;
        let auth;
        let db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // Membuat layanan Firebase dapat diakses secara global untuk kemudahan
            window.firebaseServices = { auth, db, collection, addDoc, serverTimestamp, doc, setDoc, getDoc, onSnapshot, deleteDoc, updateDoc, getDocs };
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Error initializing Firebase. Please check your config.", e);
            document.addEventListener('DOMContentLoaded', () => {
                const authContainer = document.getElementById('auth-container');
                if(authContainer) authContainer.innerHTML = '<p class="text-xs text-red-500">Firebase Gagal Terhubung</p>';
            });
        }
        
        // Memastikan auth state berubah
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                window.setupAuthUI(user);
            });
        }
        
        // Mengekspos fungsi auth ke window untuk diakses dari script non-module
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
    </script>

    <script>
        // Fungsi untuk menerapkan tema (terang/gelap/sistem)
        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'system';
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applyTheme();
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        textarea::-webkit-scrollbar, .scrollable::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, .scrollable::-webkit-scrollbar-track { background: #f1f5f9; }
        textarea::-webkit-scrollbar-thumb, .scrollable::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark textarea::-webkit-scrollbar-track, .dark .scrollable::-webkit-scrollbar-track { background: #1e293b; }
        .dark .scrollable::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Styling Tab Aktif */
        .tab-btn[disabled] { color: #9ca3af; cursor: not-allowed; }
        .dark .tab-btn[disabled] { color: #6b7280; }
        .tab-active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .dark .tab-active { border-bottom-color: #60a5fa; color: #60a5fa; }
        
        /* Modal Visibility */
        .modal { display: none; transition: opacity 0.3s ease; }
        .modal.flex { display: flex; }
        
        /* Progress Bar & Tombol Simpan */
        #ocr-progress-bar { width: 0%; transition: width 0.3s; }
        .save-btn-icon { fill: none; stroke: currentColor; }
        .saved .save-btn-icon { fill: currentColor; stroke: currentColor; }
        
        /* Pratinjau Gambar & Drop Zone */
        #image-viewport { cursor: grab; overflow: hidden; border-radius: 0.5rem; position: relative; }
        #image-viewport:active { cursor: grabbing; }
        #image-transformer { transition: transform 0.1s ease-out; }
        #image-preview-container { position: relative; }
        #image-preview-container canvas { max-width: 100%; height: auto; display: block; }
        #translated-canvas { position: absolute; top: 0; left: 0; }

        .drop-zone { border: 2px dashed #d1d5db; transition: background-color 0.2s, border-color 0.2s; }
        .dark .drop-zone { border-color: #4b5563; }
        .dragover { background-color: #e0f2fe; border-color: #3b82f6; }
        .dark .dragover { background-color: #1e3a8a; border-color: #60a5fa; }
        
        /* Kamus & Toggle Switch */
        .dict-word { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-decoration-color: #3b82f6; }
        .toggle-label { transition: background-color 0.2s ease-in; }
        .toggle-label .dot { transition: transform 0.2s ease-in; }
        input.toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        input.toggle-checkbox:checked + .toggle-label .dot { transform: translateX(100%); }

        /* Loader/Spinner untuk Tombol AI */
        .loader {
            width: 18px; height: 18px; border: 2px solid #FFF;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .ai-action-btn .loader, #target-speak-btn .loader, #check-grammar-btn .loader {
             border-color: #3b82f6; border-bottom-color: transparent;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tombol Rekam Suara (Mode Percakapan) */
        .mic-btn.recording { animation: pulse 1.5s infinite; background-color: #ef4444; }
        .mic-btn.recording:hover { background-color: #dc2626; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .mic-btn.recording.pulse-red { animation-name: pulse-red; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* Opsi Terjemahan Alternatif */
        .alternative-translation { cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background-color 0.2s; }
        .alternative-translation:hover { background-color: #eef2ff; }
        .dark .alternative-translation:hover { background-color: #374151; }
        #alternative-translations { max-height: 80px; }
        
        /* Gaya untuk Teks Prediktif */
        #predictive-text { cursor: pointer; transition: color 0.2s; }

        /* Gaya untuk Perbandingan Teks Koreksi */
        #correction-diff del { background-color: #fecaca; text-decoration: line-through; }
        #correction-diff ins { background-color: #bbf7d0; text-decoration: none; }
        .dark #correction-diff del { background-color: #450a0a; }
        .dark #correction-diff ins { background-color: #14532d; }

        /* Gaya untuk Gamifikasi */
        .badge { opacity: 0.3; filter: grayscale(1); transition: all 0.3s ease; }
        .badge.earned { opacity: 1; filter: grayscale(0); }

        /* Gaya untuk Kuis */
        .quiz-option { transition: background-color 0.2s; }
        .quiz-option.correct { background-color: #bbf7d0; }
        .dark .quiz-option.correct { background-color: #166534; }
        .quiz-option.incorrect { background-color: #fecaca; }
        .dark .quiz-option.incorrect { background-color: #991b1b; }

        /* Gaya untuk Tombol Feedback */
        .feedback-btn svg { transition: transform 0.2s ease-in-out; }
        .feedback-btn:hover svg { transform: scale(1.2); }
        .feedback-btn.selected { color: #3b82f6; }
        .dark .feedback-btn.selected { color: #60a5fa; }

        /* Gaya untuk Kamera */
        #camera-feed {
            transform: scaleX(-1); /* Cerminkan video agar seperti cermin */
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <div class="w-full min-h-screen flex flex-col">
        <!-- Header -->
        <header class="flex flex-wrap items-center justify-between gap-4 p-4 border-b border-slate-200 dark:border-gray-700 shadow-sm bg-white dark:bg-gray-800 sticky top-0 z-30">
            <h1 class="text-xl font-bold text-slate-800 dark:text-slate-100">Penerjemah Hoshi ‚≠ê</h1>
            <div class="flex items-center gap-2 sm:gap-4">
                <!-- Kontainer Otentikasi -->
                <div id="auth-container" class="flex items-center gap-2">
                    <button id="login-btn" class="text-sm font-semibold text-blue-600 hover:underline">Login</button>
                    <button id="register-btn" class="text-sm font-semibold bg-blue-600 text-white py-1.5 px-3 rounded-md hover:bg-blue-700 transition-transform hover:scale-105">Daftar</button>
                </div>
                <div id="user-info" class="hidden items-center gap-2">
                    <span id="user-email" class="text-sm font-medium text-slate-600 dark:text-slate-300 truncate max-w-[100px] sm:max-w-xs"></span>
                    <div class="flex items-center gap-1 text-sm font-semibold text-amber-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z" clip-rule="evenodd" /></svg>
                        <span id="user-points">0</span>
                    </div>
                    <button id="profile-btn" class="hidden sm:inline text-sm font-semibold text-slate-600 dark:text-slate-300 hover:underline">Profil</button>
                    <button id="logout-btn" class="text-sm font-semibold text-red-500 hover:underline flex-shrink-0">Logout</button>
                </div>

                <div class="h-6 w-px bg-slate-200 dark:bg-gray-700"></div>
                
                <button id="word-of-the-day-btn" aria-label="Kata Hari Ini" title="Kata Hari Ini" class="text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                </button>
                <button id="api-key-btn" aria-label="Kunci API" title="Kelola Kunci API Gemini" class="text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v-2l1-1 1-1 .257-.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg>
                </button>
                <button id="settings-btn" aria-label="Pengaturan" class="text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.405 1.05c.412-1.363 2.387-1.363 2.799 0l.34 1.125a1.5 1.5 0 001.482 1.05h1.181c1.423 0 2.013 1.795.898 2.65l-.948.69a1.5 1.5 0 00-.573 1.752l.34 1.125c.412 1.363-.93 2.65-2.235 1.752l-.948-.69a1.5 1.5 0 00-1.752 0l-.948.69c-1.305.9-2.647-.39-2.235-1.752l.34-1.125a1.5 1.5 0 00-.573-1.752l-.948-.69c-1.115-.855-.525-2.65.898-2.65h1.181a1.5 1.5 0 001.482-1.05l.34-1.125zM10 6a1.5 1.5 0 100 3 1.5 1.5 0 000-3z"/></svg>
                </button>
                <div class="relative">
                    <button id="theme-menu-button" aria-label="Menu Tema" class="text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
                    </button>
                    <div id="theme-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20 border border-slate-200 dark:border-gray-700">
                        <a href="#" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-gray-700" data-theme="light">Terang</a>
                        <a href="#" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-gray-700" data-theme="dark">Gelap</a>
                        <a href="#" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-gray-700" data-theme="system">Ikuti Sistem</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col items-center p-2 sm:p-4 md:p-6 lg:p-8">
            <div id="login-prompt" class="w-full max-w-5xl text-center">
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Selamat Datang di Penerjemah Hoshi</h2>
                    <p class="text-slate-600 dark:text-slate-300 mb-6">Silakan login atau daftar akun untuk mengakses semua fitur canggih kami.</p>
                    <div class="flex justify-center gap-4">
                        <button id="login-prompt-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Login</button>
                        <button id="register-prompt-btn" class="bg-slate-200 dark:bg-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-600">Daftar</button>
                    </div>
                </div>
            </div>

            <div id="main-content-wrapper" class="w-full max-w-6xl hidden">
                <div class="w-full border-b border-slate-200 dark:border-gray-700 mb-4">
                    <div class="flex overflow-x-auto scrollable">
                        <button class="tab-btn tab-active flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm border-b-2 border-transparent transition-colors" data-tab="text">Teks</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="voice">Percakapan</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="image">Gambar</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="document">Dokumen</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="subtitle">Subtitle</button>
                        <!-- Tabs Premium -->
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="audio">Audio üéµüíé</button>
                        <button id="ai-tab-btn" class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="ai">Asisten AI üíé</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="lyrics">Lirik Lagu üíé</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="code">Kode üíé</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="quiz">Kuis Bahasa üíé</button>
                        <!-- FITUR BARU: Diaktifkan -->
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="camera">Kamera üì∏</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="partner">Language Partner ü§ù</button>
                        <button id="admin-tab-btn" class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-red-500 border-b-2 border-transparent transition-colors hidden" data-tab="admin">Admin ‚öôÔ∏è</button>
                    </div>
                </div>

                <!-- Text Translation Panel -->
                <div id="text-panel" class="tab-panel">
                    <div class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg shadow-sm">
                        <div class="flex flex-col sm:flex-row items-center justify-between p-3 sm:p-4 border-b border-slate-200 dark:border-gray-700 gap-2">
                             <select id="source-lang" class="w-full sm:w-auto bg-white dark:bg-gray-800 text-sm font-semibold focus:outline-none cursor-pointer"></select>
                             <button id="swap-btn" title="Tukar bahasa" class="p-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-full transition-colors hover:rotate-180">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                             </button>
                             <select id="target-lang" class="w-full sm:w-auto b
