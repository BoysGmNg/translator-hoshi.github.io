<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penerjemah Hoshi (Ditingkatkan)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tesseract.js untuk OCR pada gambar -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <!-- Firebase SDK - Diperbarui ke versi modular terbaru -->
    <script type="module">
        // Mengimpor fungsi yang diperlukan dari SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // KONFIGURASI FIREBASE ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyCybId57osSubD6X5wA0V780dtMjgA69o8", // Kunci API Firebase yang benar
            authDomain: "translator-hosh.firebaseapp.com",
            projectId: "translator-hoshi",
            storageBucket: "translator-hoshi.appspot.com",
            messagingSenderId: "...", 
            appId: "..." 
        };

        // Inisialisasi Firebase
        let app;
        let auth;
        let db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // Membuat layanan Firebase dapat diakses secara global untuk kemudahan
            window.firebaseServices = { auth, db, collection, addDoc, serverTimestamp, doc, setDoc, getDoc, onSnapshot, deleteDoc };
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Error initializing Firebase. Please check your config.", e);
            document.addEventListener('DOMContentLoaded', () => {
                const authContainer = document.getElementById('auth-container');
                if(authContainer) authContainer.innerHTML = '<p class="text-xs text-red-500">Firebase Gagal Terhubung</p>';
            });
        }
        
        // Memastikan auth state berubah
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                window.setupAuthUI(user);
            });
        }
        
        // Mengekspos fungsi auth ke window untuk diakses dari script non-module
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
    </script>

    <script>
        // Fungsi untuk menerapkan tema (terang/gelap/sistem)
        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'system';
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applyTheme();
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        textarea::-webkit-scrollbar, .scrollable::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, .scrollable::-webkit-scrollbar-track { background: #f1f5f9; }
        textarea::-webkit-scrollbar-thumb, .scrollable::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark textarea::-webkit-scrollbar-track, .dark .scrollable::-webkit-scrollbar-track { background: #1e293b; }
        .dark .scrollable::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Styling Tab Aktif */
        .tab-btn[disabled] { color: #9ca3af; cursor: not-allowed; }
        .dark .tab-btn[disabled] { color: #6b7280; }
        .tab-active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .dark .tab-active { border-bottom-color: #60a5fa; color: #60a5fa; }
        
        /* Modal Visibility */
        .modal { display: none; transition: opacity 0.3s ease; }
        .modal.flex { display: flex; }
        
        /* Progress Bar & Tombol Simpan */
        #ocr-progress-bar { width: 0%; transition: width 0.3s; }
        .save-btn-icon { fill: none; stroke: currentColor; }
        .saved .save-btn-icon { fill: currentColor; stroke: currentColor; }
        
        /* Pratinjau Gambar & Drop Zone */
        #image-viewport { cursor: grab; overflow: hidden; border-radius: 0.5rem; position: relative; }
        #image-viewport:active { cursor: grabbing; }
        #image-transformer { transition: transform 0.1s ease-out; }
        #image-preview-container { position: relative; }
        #image-preview-container canvas { max-width: 100%; height: auto; display: block; }
        #translated-canvas { position: absolute; top: 0; left: 0; }

        .drop-zone { border: 2px dashed #d1d5db; transition: background-color 0.2s, border-color 0.2s; }
        .dark .drop-zone { border-color: #4b5563; }
        .dragover { background-color: #e0f2fe; border-color: #3b82f6; }
        .dark .dragover { background-color: #1e3a8a; border-color: #60a5fa; }
        
        /* Kamus & Toggle Switch */
        .dict-word { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-decoration-color: #3b82f6; }
        .toggle-label { transition: background-color 0.2s ease-in; }
        .toggle-label .dot { transition: transform 0.2s ease-in; }
        input.toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        input.toggle-checkbox:checked + .toggle-label .dot { transform: translateX(100%); }

        /* Loader/Spinner untuk Tombol AI */
        .loader {
            width: 18px; height: 18px; border: 2px solid #FFF;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .ai-action-btn .loader, #target-speak-btn .loader, #check-grammar-btn .loader {
             border-color: #3b82f6; border-bottom-color: transparent;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tombol Rekam Suara (Mode Percakapan) */
        .mic-btn.recording { animation: pulse 1.5s infinite; background-color: #ef4444; }
        .mic-btn.recording:hover { background-color: #dc2626; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .mic-btn.recording.pulse-red { animation-name: pulse-red; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* Opsi Terjemahan Alternatif */
        .alternative-translation { cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background-color 0.2s; }
        .alternative-translation:hover { background-color: #eef2ff; }
        .dark .alternative-translation:hover { background-color: #374151; }
        #alternative-translations { max-height: 80px; }
        
        /* Gaya untuk Teks Prediktif */
        #predictive-text { cursor: pointer; transition: color 0.2s; }

        /* Gaya untuk Perbandingan Teks Koreksi */
        #correction-diff del { background-color: #fecaca; text-decoration: line-through; }
        #correction-diff ins { background-color: #bbf7d0; text-decoration: none; }
        .dark #correction-diff del { background-color: #450a0a; }
        .dark #correction-diff ins { background-color: #14532d; }

        /* Gaya untuk Gamifikasi */
        .badge { opacity: 0.3; filter: grayscale(1); transition: all 0.3s ease; }
        .badge.earned { opacity: 1; filter: grayscale(0); }

        /* Gaya untuk Kuis */
        .quiz-option { transition: background-color 0.2s; }
        .quiz-option.correct { background-color: #bbf7d0; }
        .dark .quiz-option.correct { background-color: #166534; }
        .quiz-option.incorrect { background-color: #fecaca; }
        .dark .quiz-option.incorrect { background-color: #991b1b; }

        /* Gaya untuk Tombol Feedback */
        .feedback-btn svg { transition: transform 0.2s ease-in-out; }
        .feedback-btn:hover svg { transform: scale(1.2); }
        .feedback-btn.selected { color: #3b82f6; }
        .dark .feedback-btn.selected { color: #60a5fa; }

        /* Gaya untuk Kamera */
        #camera-feed {
            transform: scaleX(-1); /* Cerminkan video agar seperti cermin */
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <div class="w-full min-h-screen flex flex-col">
        <!-- Header -->
        <header class="flex flex-wrap items-center justify-between gap-4 p-4 border-b border-slate-200 dark:border-gray-700 shadow-sm bg-white dark:bg-gray-800 sticky top-0 z-30">
            <h1 class="text-xl font-bold text-slate-800 dark:text-slate-100">Penerjemah Hoshi ‚≠ê</h1>
            <div class="flex items-center gap-2 sm:gap-4">
                <!-- Kontainer Otentikasi -->
                <div id="auth-container" class="flex items-center gap-2">
                    <button id="login-btn" class="text-sm font-semibold text-blue-600 hover:underline">Login</button>
                    <button id="register-btn" class="text-sm font-semibold bg-blue-600 text-white py-1.5 px-3 rounded-md hover:bg-blue-700 transition-transform hover:scale-105">Daftar</button>
                </div>
                <div id="user-info" class="hidden items-center gap-2">
                    <span id="user-email" class="text-sm font-medium text-slate-600 dark:text-slate-300 truncate max-w-[100px] sm:max-w-xs"></span>
                    <div class="flex items-center gap-1 text-sm font-semibold text-amber-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z" clip-rule="evenodd" /></svg>
                        <span id="user-points">0</span>
                    </div>
                    <button id="profile-btn" class="hidden sm:inline text-sm font-semibold text-slate-600 dark:text-slate-300 hover:underline">Profil</button>
                    <button id="logout-btn" class="text-sm font-semibold text-red-500 hover:underline flex-shrink-0">Logout</button>
                </div>

                <div class="h-6 w-px bg-slate-200 dark:bg-gray-700"></div>
                
                <button id="word-of-the-day-btn" aria-label="Kata Hari Ini" title="Kata Hari Ini" class="text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                </button>
                <button id="api-key-btn" aria-label="Kunci API" title="Kelola Kunci API Gemini" class="text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v-2l1-1 1-1 .257-.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg>
                </button>
                <button id="settings-btn" aria-label="Pengaturan" class="text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.405 1.05c.412-1.363 2.387-1.363 2.799 0l.34 1.125a1.5 1.5 0 001.482 1.05h1.181c1.423 0 2.013 1.795.898 2.65l-.948.69a1.5 1.5 0 00-.573 1.752l.34 1.125c.412 1.363-.93 2.65-2.235 1.752l-.948-.69a1.5 1.5 0 00-1.752 0l-.948.69c-1.305.9-2.647-.39-2.235-1.752l.34-1.125a1.5 1.5 0 00-.573-1.752l-.948-.69c-1.115-.855-.525-2.65.898-2.65h1.181a1.5 1.5 0 001.482-1.05l.34-1.125zM10 6a1.5 1.5 0 100 3 1.5 1.5 0 000-3z"/></svg>
                </button>
                <div class="relative">
                    <button id="theme-menu-button" aria-label="Menu Tema" class="text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
                    </button>
                    <div id="theme-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20 border border-slate-200 dark:border-gray-700">
                        <a href="#" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-gray-700" data-theme="light">Terang</a>
                        <a href="#" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-gray-700" data-theme="dark">Gelap</a>
                        <a href="#" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-gray-700" data-theme="system">Ikuti Sistem</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col items-center p-2 sm:p-4 md:p-6 lg:p-8">
            <div id="login-prompt" class="w-full max-w-5xl text-center">
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Selamat Datang di Penerjemah Hoshi</h2>
                    <p class="text-slate-600 dark:text-slate-300 mb-6">Silakan login atau daftar akun untuk mengakses semua fitur canggih kami.</p>
                    <div class="flex justify-center gap-4">
                        <button id="login-prompt-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Login</button>
                        <button id="register-prompt-btn" class="bg-slate-200 dark:bg-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-600">Daftar</button>
                    </div>
                </div>
            </div>

            <div id="main-content-wrapper" class="w-full max-w-6xl hidden">
                <div class="w-full border-b border-slate-200 dark:border-gray-700 mb-4">
                    <div class="flex overflow-x-auto scrollable">
                        <button class="tab-btn tab-active flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm border-b-2 border-transparent transition-colors" data-tab="text">Teks</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="voice">Percakapan</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="image">Gambar</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="document">Dokumen</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="subtitle">Subtitle</button>
                        <!-- Tabs Premium -->
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="audio">Audio üéµüíé</button>
                        <button id="ai-tab-btn" class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="ai">Asisten AI üíé</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="lyrics">Lirik Lagu üíé</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="code">Kode üíé</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="quiz">Kuis Bahasa üíé</button>
                        <!-- FITUR BARU: Diaktifkan -->
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="camera">Kamera üì∏</button>
                        <button class="tab-btn flex-shrink-0 flex items-center gap-2 py-3 px-4 text-sm text-slate-500 dark:text-slate-400 border-b-2 border-transparent transition-colors" data-tab="partner">Language Partner ü§ù</button>
                    </div>
                </div>

                <!-- Text Translation Panel -->
                <div id="text-panel" class="tab-panel">
                    <div class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg shadow-sm">
                        <div class="flex flex-col sm:flex-row items-center justify-between p-3 sm:p-4 border-b border-slate-200 dark:border-gray-700 gap-2">
                             <select id="source-lang" class="w-full sm:w-auto bg-white dark:bg-gray-800 text-sm font-semibold focus:outline-none cursor-pointer"></select>
                             <button id="swap-btn" title="Tukar bahasa" class="p-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-full transition-colors hover:rotate-180">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                             </button>
                             <select id="target-lang" class="w-full sm:w-auto bg-white dark:bg-gray-800 text-sm font-semibold focus:outline-none cursor-pointer"></select>
                        </div>
                        <div class="grid md:grid-cols-2">
                            <div class="p-4 flex flex-col border-b md:border-b-0 md:border-r border-slate-200 dark:border-gray-700 min-h-[250px]">
                                <div class="relative flex-grow">
                                    <textarea id="source-text" class="w-full h-full bg-transparent resize-none focus:outline-none text-lg" placeholder="Masukkan teks..."></textarea>
                                    <div id="predictive-text-container" class="absolute top-0 left-0 w-full h-full text-lg pointer-events-none">
                                        <span id="predictive-text-suggestion" class="text-gray-400 dark:text-gray-500"></span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-200 dark:border-gray-700">
                                    <div class="flex gap-2">
                                        <button id="source-speak-btn" aria-label="Dengarkan teks sumber" title="Dengarkan teks sumber" class="p-2 text-slate-400 hover:text-blue-500 transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5.071 8.043a.75.75 0 01.275-.566l3.5-2.5a.75.75 0 011.154.566v10a.75.75 0 01-1.154.566l-3.5-2.5a.75.75 0 01-.275-.566H4.75a.75.75 0 010-1.5h.321z" /><path d="M11.75 6.12a.75.75 0 011.5 0v7.76a.75.75 0 01-1.5 0V6.12zM14.622 4.332a.75.75 0 011.06 0l.07.07a.75.75 0 010 1.06l-.07.07a5.5 5.5 0 010 7.778l.07.07a.75.75 0 010 1.06l-.07.07a.75.75 0 01-1.06 0l-.07-.07a7 7 0 010-9.9l.07-.07z" /></svg></button>
                                        <button id="check-grammar-btn" aria-label="Periksa Teks dengan AI" title="Periksa Teks dengan AI" class="p-2 text-slate-400 hover:text-blue-500 transition-colors flex items-center gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>
                                            <span class="text-xs font-bold">AI</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </div>
                                    <div class="text-right text-xs text-slate-400" id="char-count">0 / 5.000</div>
                                </div>
                            </div>
                            <div class="p-4 relative flex flex-col min-h-[250px]">
                                 <div class="flex justify-end items-center mb-2">
                                    <label for="glossary-toggle" class="flex items-center cursor-pointer text-sm font-medium text-slate-600 dark:text-slate-300">
                                        Glosarium
                                        <div class="relative inline-block w-10 ml-2 align-middle select-none">
                                            <input type="checkbox" name="toggle" id="glossary-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                            <label for="glossary-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer"><span class="dot absolute left-0 top-0 block w-6 h-6 rounded-full bg-white shadow-md"></span></label>
                                        </div>
                                    </label>
                                    <button id="glossary-manage-btn" class="ml-2 text-blue-500 hover:underline text-sm font-semibold hidden">Kelola</button>
                                </div>
                                <div id="translated-output-container" class="w-full bg-transparent resize-none text-lg flex-grow overflow-y-auto scrollable">
                                    <div id="translated-output" title="Klik sebuah kata untuk melihat definisinya"></div>
                                    <div id="romanization-output" class="text-base italic text-slate-500 dark:text-slate-400 mt-1"></div>
                                    <div id="alternative-translations" class="mt-2 text-sm text-slate-600 dark:text-slate-300 space-y-1 overflow-y-auto scrollable"></div>
                                </div>
                                <!-- FITUR BARU: Rating dan Koreksi -->
                                <div id="feedback-container" class="mt-2 pt-2 border-t border-slate-200 dark:border-gray-700 hidden">
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Beri peringkat terjemahan ini:</p>
                                    <div class="flex items-center gap-4">
                                        <div class="flex gap-2">
                                            <button class="feedback-btn p-1 text-slate-400 hover:text-green-500" data-rating="good" title="Bagus">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333V17a1 1 0 001 1h6.364a1 1 0 00.943-.684l1.757-6.15a1 1 0 00-.943-1.316H12V4.5a1.5 1.5 0 00-3 0v5.833H6z" /></svg>
                                            </button>
                                            <button class="feedback-btn p-1 text-slate-400 hover:text-red-500" data-rating="bad" title="Kurang Baik">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M18 9.5a1.5 1.5 0 11-3 0v-6a1.5 1.5 0 013 0v6zM14 9.667V3a1 1 0 00-1-1H6.636a1 1 0 00-.943.684l-1.757 6.15a1 1 0 00.943 1.316H8v8.5a1.5 1.5 0 003 0V9.667h3z" /></svg>
                                            </button>
                                        </div>
                                        <button id="suggest-edit-btn" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Sarankan perbaikan</button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-200 dark:border-gray-700">
                                    <div class="flex gap-2 items-center">
                                        <button id="target-speak-btn" aria-label="Dengarkan terjemahan" title="Dengarkan terjemahan" class="p-2 text-slate-400 hover:text-blue-500 transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5.071 8.043a.75.75 0 01.275-.566l3.5-2.5a.75.75 0 011.154.566v10a.75.75 0 01-1.154.566l-3.5-2.5a.75.75 0 01-.275-.566H4.75a.75.75 0 010-1.5h.321z" /><path d="M11.75 6.12a.75.75 0 011.5 0v7.76a.75.75 0 01-1.5 0V6.12zM14.622 4.332a.75.75 0 011.06 0l.07.07a.75.75 0 010 1.06l-.07.07a5.5 5.5 0 010 7.778l.07.07a.75.75 0 010 1.06l-.07.07a.75.75 0 01-1.06 0l-.07-.07a7 7 0 010-9.9l.07-.07z" /></svg></button>
                                        <select id="voice-tone-select" class="hidden sm:inline-block text-xs bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-1 focus:outline-none">
                                            <option value="standar">Nada Standar</option>
                                            <option value="kasual">Nada Kasual</option>
                                            <option value="formal">Nada Formal</option>
                                        </select>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="copy-btn" aria-label="Salin" title="Salin" class="p-2 text-slate-400 hover:text-blue-500 transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3.5A1.5 1.5 0 018.5 2h5.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 01.439 1.061V16.5A1.5 1.5 0 0116.5 18h-8A1.5 1.5 0 017 16.5v-13z" /><path d="M6 4.5A2.5 2.5 0 003.5 7v10A2.5 2.5 0 006 19.5h7A2.5 2.5 0 0015.5 17V7A2.5 2.5 0 0013 4.5H6z" /></svg></button>
                                        <button id="google-search-btn" aria-label="Telusuri dengan Google" title="Telusuri dengan Google" class="p-2 text-slate-400 hover:text-blue-500 transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.75 8.36,4.73 12.19,4.73C15.28,4.73 17.04,6.84 17.04,6.84L19.05,4.83C19.05,4.83 16.56,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.2 6.42,22 12.19,22C17.6,22 21.54,18.33 21.54,12.25C21.54,11.76 21.48,11.43 21.35,11.1Z" /></svg></button>
                                        <button id="share-btn" aria-label="Bagikan" title="Bagikan" class="p-2 text-slate-400 hover:text-blue-500 transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M13 4.5a2.5 2.5 0 11.702 4.281l-4.147 2.13a2.502 2.502 0 010 1.178l4.147 2.13A2.5 2.5 0 1113 15.5v-1.352a2.504 2.504 0 01-.298-.918l-4.147-2.13a2.5 2.5 0 010-1.178l4.147-2.13A2.504 2.504 0 0113 5.852V4.5z" /></svg></button>
                                        <button id="save-translation-btn" aria-label="Simpan terjemahan" title="Simpan terjemahan" class="p-2 text-slate-400 hover:text-yellow-500 transition-colors"><svg class="w-5 h-5 save-btn-icon" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.539 1.118l-3.975-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.539-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="dictionary-result" class="mt-4 p-4 bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg hidden shadow-sm"></div>
                </div>

                <!-- Voice Translation Panel -->
                <div id="voice-panel" class="tab-panel hidden">
                    <div class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg shadow-sm flex flex-col" style="height: 65vh;">
                        <div id="speech-recognition-unsupported" class="hidden text-center text-red-500 bg-red-100 dark:bg-red-900 dark:text-red-300 p-3 rounded-t-lg">
                            Maaf, browser Anda tidak mendukung fitur pengenalan suara. Coba gunakan Google Chrome.
                        </div>
                        <div id="conversation-view" class="flex-grow p-4 overflow-y-auto scrollable">
                            <p id="conversation-placeholder" class="text-center text-slate-400 dark:text-slate-500 h-full flex items-center justify-center">Ketuk tombol mikrofon untuk memulai percakapan...</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center justify-around gap-2 sm:gap-4 p-4 border-t border-slate-200 dark:border-gray-700">
                            <select id="conversation-lang-1" class="w-full sm:w-auto bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-2 text-sm font-semibold"></select>
                            <button id="mic-btn-1" data-lang-select="conversation-lang-1" class="mic-btn bg-blue-600 text-white rounded-full p-4 hover:bg-blue-700 transition-colors duration-300 focus:outline-none flex-shrink-0">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path fill-rule="evenodd" d="M5.5 8.5A.5.5 0 016 9v1a4 4 0 004 4 4 4 0 004-4V9a.5.5 0 011 0v1a5 5 0 01-4.5 4.975V17h3a.5.5 0 010 1h-7a.5.5 0 010-1h3v-2.025A5 5 0 015 10V9a.5.5 0 01.5-.5z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="conversation-swap-btn" title="Tukar bahasa percakapan" class="p-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-full transition-colors flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                            </button>
                            <button id="mic-btn-2" data-lang-select="conversation-lang-2" class="mic-btn bg-blue-600 text-white rounded-full p-4 hover:bg-blue-700 transition-colors duration-300 focus:outline-none flex-shrink-0">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path fill-rule="evenodd" d="M5.5 8.5A.5.5 0 016 9v1a4 4 0 004 4 4 4 0 004-4V9a.5.5 0 011 0v1a5 5 0 01-4.5 4.975V17h3a.5.5 0 010 1h-7a.5.5 0 010-1h3v-2.025A5 5 0 015 10V9a.5.5 0 01.5-.5z" clip-rule="evenodd" /></svg>
                            </button>
                            <select id="conversation-lang-2" class="w-full sm:w-auto bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-2 text-sm font-semibold"></select>
                        </div>
                    </div>
                </div>

                <!-- Audio Translation Panel -->
                <div id="audio-panel" class="tab-panel hidden">
                    <div id="audio-content-wrapper" class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                        <h2 class="text-lg font-semibold mb-4 text-center">Penerjemah Audio üéµüíé</h2>
                        <div id="audio-drop-zone" class="drop-zone w-full bg-white dark:bg-gray-800 rounded-lg p-6 text-center cursor-pointer">
                            <p class="text-slate-500 dark:text-slate-400 mb-2">Seret & lepas file audio, atau klik untuk memilih.</p>
                            <p class="text-xs text-slate-400 mb-4">Mendukung .mp3, .wav, .ogg</p>
                            <input type="file" id="audio-upload" accept="audio/*" class="hidden"/>
                            <button id="audio-upload-btn" class="bg-blue-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-blue-700 transition-colors">Pilih File Audio</button>
                            <p id="audio-file-name" class="text-sm font-medium mt-2"></p>
                        </div>
                        <div class="flex justify-center items-center gap-2 my-4"><span>Terjemahkan teks ke:</span><select id="audio-target-lang" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-1 text-sm"></select></div>
                        <div class="mt-4 grid md:grid-cols-2 gap-4">
                            <div class="flex flex-col">
                                <h3 class="font-semibold mb-1 text-center">Teks Asli (Transkripsi)</h3>
                                <pre id="audio-transcribed-text" class="scrollable w-full h-48 bg-slate-100 dark:bg-gray-700 rounded-lg p-3 overflow-auto whitespace-pre-wrap"><span class="text-slate-400">Hasil transkripsi audio akan muncul di sini...</span></pre>
                            </div>
                            <div class="flex flex-col">
                                <h3 class="font-semibold mb-1 text-center">Teks Terjemahan</h3>
                                <pre id="audio-translated-text" class="scrollable w-full h-48 bg-slate-100 dark:bg-gray-700 rounded-lg p-3 overflow-auto whitespace-pre-wrap"><span class="text-slate-400">Hasil terjemahan akan muncul di sini...</span></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Panel -->
                <div id="ai-panel" class="tab-panel hidden">
                    <div id="ai-content-wrapper" class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                        <h2 class="text-lg font-semibold mb-4 text-center">Asisten Tulisan AI üíé</h2>
                        <div class="flex justify-center items-center gap-2 mb-4">
                            <label for="ai-domain-select" class="font-semibold text-sm">Konteks Terjemahan:</label>
                            <select id="ai-domain-select" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-1 text-sm font-semibold">
                                <option value="Umum">Umum</option>
                                <option value="Medis">Medis</option>
                                <option value="Hukum">Hukum</option>
                                <option value="Teknis">Teknis</option>
                                <option value="Akademik">Akademik</option>
                            </select>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <textarea id="ai-source" class="w-full h-48 bg-slate-50 dark:bg-gray-700 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="Masukkan teks untuk diubah oleh AI..."></textarea>
                            <textarea id="ai-result" class="w-full h-48 bg-slate-50 dark:bg-gray-700 rounded-lg p-3 focus:outline-none" placeholder="Hasil yang disempurnakan oleh AI..." readonly></textarea>
                        </div>
                        <div id="ai-controls" class="flex flex-wrap justify-center items-center gap-2 mt-4">
                            <button class="ai-action-btn bg-slate-200 dark:bg-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500 transition-colors flex items-center gap-2" data-action="shorten"><span class="btn-text">Persingkat</span><div class="loader hidden"></div></button>
                            <button class="ai-action-btn bg-slate-200 dark:bg-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500 transition-colors flex items-center gap-2" data-action="lengthen"><span class="btn-text">Perpanjang</span><div class="loader hidden"></div></button>
                            <button class="ai-action-btn bg-slate-200 dark:bg-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500 transition-colors flex items-center gap-2" data-action="simplify"><span class="btn-text">Sederhanakan</span><div class="loader hidden"></div></button>
                            <button class="ai-action-btn bg-slate-200 dark:bg-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500 transition-colors flex items-center gap-2" data-action="casual"><span class="btn-text">Buat Kasual</span><div class="loader hidden"></div></button>
                            <button class="ai-action-btn bg-slate-200 dark:bg-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500 transition-colors flex items-center gap-2" data-action="professional"><span class="btn-text">Buat Profesional</span><div class="loader hidden"></div></button>
                            <button id="ai-change-style-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Gaya Lainnya...</button>
                        </div>
                    </div>
                </div>

                <!-- Image Translation Panel -->
                <div id="image-panel" class="tab-panel hidden">
                    <div id="image-drop-zone" class="drop-zone w-full bg-white dark:bg-gray-800 rounded-lg p-4 text-center">
                        <h2 class="text-lg font-semibold mb-2">Terjemahkan & Ganti Teks di Gambar</h2>
                        <div class="flex justify-center items-center gap-2 mb-4"><span>Terjemahkan ke:</span><select id="image-target-lang" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-1 text-sm"></select></div>
                        <input type="file" id="image-upload" accept="image/*" class="hidden"/><button onclick="document.getElementById('image-upload').click()" class="bg-blue-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-blue-700 transition-colors">Pilih Gambar</button>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">atau seret & lepas gambar di sini</p>
                        <div id="ocr-status" class="mt-4 text-sm font-medium"></div>
                        <div id="ocr-progress" class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-2 hidden"><div id="ocr-progress-bar" class="bg-blue-600 h-2.5 rounded-full"></div></div>
                        <div id="image-viewport" class="mt-4 w-full bg-slate-100 dark:bg-gray-700 min-h-[300px] rounded-lg">
                            <div id="image-transformer"><div id="image-preview-container"></div></div>
                        </div>
                        <div id="image-controls" class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4 bg-slate-100 dark:bg-gray-700 p-2 rounded-lg">
                            <div class="flex items-center gap-4">
                                <button id="zoom-out-btn" class="font-bold text-lg px-3 py-1 rounded-md hover:bg-slate-200 dark:hover:bg-gray-600">-</button>
                                <span id="zoom-level-display" class="font-semibold text-sm w-16 text-center">100%</span>
                                <button id="zoom-in-btn" class="font-bold text-lg px-3 py-1 rounded-md hover:bg-slate-200 dark:hover:bg-gray-600">+</button>
                                <button id="reset-view-btn" class="text-sm font-semibold px-3 py-1 rounded-md hover:bg-slate-200 dark:hover:bg-gray-600">Reset</button>
                            </div>
                            <label for="compare-toggle" class="flex items-center cursor-pointer text-sm font-medium text-slate-600 dark:text-slate-300 mt-2 sm:mt-0">
                                <div class="relative inline-block w-10 ml-2 align-middle select-none">
                                    <input type="checkbox" name="toggle" id="compare-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="compare-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer"><span class="dot absolute left-0 top-0 block w-6 h-6 rounded-full bg-white shadow-md"></span></label>
                                </div>
                                <span class="ml-2">Bandingkan Asli</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Document Translation Panel -->
                <div id="document-panel" class="tab-panel hidden">
                     <div id="doc-drop-zone" class="drop-zone w-full bg-white dark:bg-gray-800 rounded-lg p-4 text-center">
                        <h2 class="text-lg font-semibold mb-2">Terjemahkan Dokumen</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Unggah file berbasis teks (.txt, .md, .csv, .json, .xml).<br><span class="text-xs">Catatan: Format kompleks seperti .pdf dan .docx belum didukung.</span></p>
                        <div class="flex justify-center items-center gap-2 mb-4"><span>Terjemahkan ke:</span><select id="doc-target-lang" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-1 text-sm"></select></div>
                        <input type="file" id="doc-upload" accept=".txt,.md,.csv,.json,.xml" class="hidden"/><button onclick="document.getElementById('doc-upload').click()" class="bg-blue-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-blue-700 transition-colors">Pilih Dokumen</button>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">atau seret & lepas file di sini</p>
                        <div id="doc-status" class="mt-4 text-sm"></div>
                        <pre id="doc-text-result" class="scrollable w-full h-64 mt-4 bg-slate-100 dark:bg-gray-700 rounded-lg p-2 text-left overflow-auto whitespace-pre-wrap"><span class="text-slate-400">Hasil terjemahan dokumen akan muncul di sini...</span></pre>
                    </div>
                </div>

                <!-- Subtitle Translation Panel -->
                <div id="subtitle-panel" class="tab-panel hidden">
                     <div class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg p-4 text-center shadow-sm">
                        <h2 class="text-lg font-semibold mb-2">Terjemahkan Subtitle Video</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Unggah file subtitle Anda (.srt, .vtt, dll.) untuk diterjemahkan oleh AI.</p>
                        <div class="flex justify-center items-center gap-2 mb-4"><span>Terjemahkan ke:</span><select id="video-target-lang" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-1 text-sm"></select></div>
                        <input type="file" id="subtitle-upload" accept=".srt,.vtt,.ass,.txt,.subrip,.stl,.ssa" class="hidden"/>
                        <button onclick="document.getElementById('subtitle-upload').click()" class="bg-blue-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-blue-700 transition-colors">Pilih File Subtitle</button>
                        <div id="video-status" class="mt-4 text-sm"></div>
                        <div class="mt-4 grid md:grid-cols-2 gap-4">
                            <pre id="subtitle-original" class="scrollable w-full h-64 bg-slate-100 dark:bg-gray-700 rounded-lg p-2 text-left overflow-auto whitespace-pre-wrap"><span class="text-slate-400">Teks asli...</span></pre>
                            <pre id="subtitle-translated" class="scrollable w-full h-64 bg-slate-100 dark:bg-gray-700 rounded-lg p-2 text-left overflow-auto whitespace-pre-wrap"><span class="text-slate-400">Teks terjemahan...</span></pre>
                        </div>
                        <button id="download-srt-btn" class="hidden mt-4 bg-green-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-green-700 transition-colors">Unduh Subtitle Terjemahan (.srt)</button>
                    </div>
                </div>
                
                <!-- Lyrics Translation Panel -->
                <div id="lyrics-panel" class="tab-panel hidden">
                    <div id="lyrics-content-wrapper" class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                        <h2 class="text-lg font-semibold mb-2 text-center">Penerjemah Lirik Lagu üíé</h2>
                        <div class="flex justify-center items-center gap-2 mb-4"><span>Terjemahkan ke:</span><select id="lyrics-target-lang" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-1 text-sm"></select></div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <textarea id="lyrics-source" class="w-full h-64 bg-slate-50 dark:bg-gray-700 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="Masukkan lirik lagu di sini..."></textarea>
                            <pre id="lyrics-result" class="scrollable w-full h-64 bg-slate-100 dark:bg-gray-700 rounded-lg p-3 overflow-auto whitespace-pre-wrap"><span class="text-slate-400">Hasil terjemahan lirik akan muncul di sini...</span></pre>
                        </div>
                        <div class="flex justify-center mt-4">
                            <button id="translate-lyrics-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <span class="btn-text">Terjemahkan Lirik</span>
                                <div class="loader hidden"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Code Translation Panel -->
                <div id="code-panel" class="tab-panel hidden">
                    <div id="code-content-wrapper" class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                        <h2 class="text-lg font-semibold mb-2 text-center">Penerjemah Komentar Kode üíé</h2>
                        <div class="flex justify-center items-center gap-2 mb-4"><span>Terjemahkan komentar ke:</span><select id="code-target-lang" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md p-1 text-sm"></select></div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <textarea id="code-source" class="w-full h-64 bg-slate-800 text-white font-mono rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="// Masukkan kode Anda di sini..."></textarea>
                            <pre id="code-result" class="scrollable w-full h-64 bg-slate-800 text-white font-mono rounded-lg p-3 overflow-auto"><span class="text-slate-400">// Hasil terjemahan komentar akan muncul di sini...</span></pre>
                        </div>
                        <div class="flex justify-center mt-4">
                            <button id="translate-code-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <span class="btn-text">Terjemahkan Komentar</span>
                                <div class="loader hidden"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quiz Panel -->
                <div id="quiz-panel" class="tab-panel hidden">
                    <div class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                        <h2 class="text-lg font-semibold mb-2 text-center">Kuis Bahasa Cerdas üíé</h2>
                        <div id="quiz-container" class="max-w-md mx-auto">
                            <div id="quiz-question" class="font-semibold text-lg mb-4 text-center min-h-[56px] flex items-center justify-center"></div>
                            <div id="quiz-options" class="space-y-2"></div>
                            <div id="quiz-feedback" class="mt-4 text-center font-semibold"></div>
                            <button id="next-quiz-btn" class="hidden mt-4 w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700">Pertanyaan Berikutnya</button>
                        </div>
                    </div>
                </div>

                <!-- Camera Panel -->
                <div id="camera-panel" class="tab-panel hidden">
                    <div class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg p-4 shadow-sm text-center">
                        <h2 class="text-lg font-semibold mb-2">Terjemahan Kamera Real-World</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Arahkan kamera Anda ke teks untuk menerjemahkannya secara langsung. <br>Fitur ini masih dalam tahap simulasi.</p>
                        <div id="camera-container" class="relative w-full max-w-lg mx-auto bg-gray-900 rounded-lg overflow-hidden aspect-video">
                            <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                            <div id="camera-overlay" class="absolute inset-0 flex items-center justify-center">
                                <div class="w-3/4 h-1/2 border-2 border-dashed border-white opacity-50"></div>
                            </div>
                            <p id="camera-permission-prompt" class="hidden absolute inset-0 bg-black bg-opacity-75 text-white flex items-center justify-center p-4">Izinkan akses kamera di browser Anda untuk menggunakan fitur ini.</p>
                        </div>
                        <button id="capture-btn" class="mt-4 bg-blue-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-blue-700 transition-colors">Ambil Gambar & Terjemahkan</button>
                        <canvas id="camera-canvas" class="hidden"></canvas>
                        <div id="camera-ocr-status" class="mt-4 text-sm font-medium"></div>
                    </div>
                </div>

                <!-- Language Partner Panel -->
                <div id="partner-panel" class="tab-panel hidden">
                     <div class="w-full bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                        <h2 class="text-lg font-semibold mb-4 text-center">Language Partner ü§ù</h2>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="md:col-span-1 p-4 bg-slate-50 dark:bg-gray-700 rounded-lg">
                                <h3 class="font-semibold mb-2">Status Anda</h3>
                                <p class="text-sm mb-1">Bahasa Ibu:</p>
                                <select id="partner-native-lang" class="w-full p-2 mb-3 border rounded text-sm dark:bg-gray-600 dark:border-gray-500"></select>
                                <p class="text-sm mb-1">Ingin Latihan Bahasa:</p>
                                <select id="partner-practice-lang" class="w-full p-2 mb-4 border rounded text-sm dark:bg-gray-600 dark:border-gray-500"></select>
                                <button id="go-online-btn" class="w-full bg-green-500 text-white font-semibold py-2 rounded-lg hover:bg-green-600">Go Online</button>
                                <button id="go-offline-btn" class="w-full bg-red-500 text-white font-semibold py-2 rounded-lg hover:bg-red-600 hidden mt-2">Go Offline</button>
                            </div>
                            <div class="md:col-span-2">
                                <h3 class="font-semibold mb-2">Partner Tersedia</h3>
                                <div id="partner-list" class="h-64 overflow-y-auto scrollable space-y-2 p-2 bg-slate-50 dark:bg-gray-700 rounded-lg">
                                    <p class="text-slate-400 text-center p-4">Mencari partner...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- History and Saved Buttons -->
            <div id="bottom-buttons" class="mt-12 flex gap-8 sm:gap-12 text-center hidden">
                <button id="history-btn" class="flex flex-col items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors"><div class="p-3 border-2 border-slate-300 dark:border-gray-600 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><span class="text-sm font-semibold">Histori</span></button>
                <button id="saved-btn" class="flex flex-col items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors"><div class="p-3 border-2 border-slate-300 dark:border-gray-600 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.539 1.118l-3.975-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.539-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg></div><span class="text-sm font-semibold">Tersimpan</span></button>
            </div>
        </main>
        
        <!-- Footer with Version Info -->
        <footer class="text-center p-4 mt-8 text-xs text-slate-500 dark:text-slate-400">
            <p>Versi 1.50 Alpha</p>
            <details class="mt-2 cursor-pointer max-w-lg mx-auto">
                <summary class="font-semibold hover:text-blue-500">Ringkasan Pembaruan</summary>
                <ul class="text-left mt-2 list-disc list-inside space-y-1 bg-slate-200 dark:bg-gray-800 p-3 rounded-lg">
                    <li>Penambahan Fitur-fitur berbasis AI dan premium.</li>
                    <li>Sekarang Penerjemah bisa multifungsi dari terjemahan teks sampai language partner.</li>
                    <li>Penerjemah sekarang memiliki fitur feedback yaitu (suka) dan (tidak suka) terjemahan.</li>
                    <li>Kelola Kunci API sekarang ada banyak opsi yaitu: Gemini, Deepseek, ChatGPT.</li>
                    <li>Peningkatan profesionalitas bahasa dan merapihkan beberapa design.</li>
                </ul>
            </details>
        </footer>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Login</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><form id="login-form" class="p-4 space-y-4"><div><label for="login-email" class="block text-sm font-medium">Email</label><input id="login-email" type="email" required class="w-full p-2 mt-1 border rounded dark:bg-gray-700 dark:border-gray-600"></div><div><label for="login-password" class="block text-sm font-medium">Password</label><input id="login-password" type="password" required class="w-full p-2 mt-1 border rounded dark:bg-gray-700 dark:border-gray-600"></div><button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700">Login</button><p id="login-error" class="text-red-500 text-sm text-center"></p></form></div></div>
    <div id="register-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Daftar Akun Baru</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><form id="register-form" class="p-4 space-y-4"><div><label for="register-email" class="block text-sm font-medium">Email</label><input id="register-email" type="email" required class="w-full p-2 mt-1 border rounded dark:bg-gray-700 dark:border-gray-600"></div><div><label for="register-password" class="block text-sm font-medium">Password (min. 6 karakter)</label><input id="register-password" type="password" required class="w-full p-2 mt-1 border rounded dark:bg-gray-700 dark:border-gray-600"></div><button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700">Daftar</button><p id="register-error" class="text-red-500 text-sm text-center"></p></form></div></div>
    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Histori Terjemahan</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><div id="history-list" class="p-4 overflow-y-auto scrollable"></div></div></div>
    <div id="saved-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Terjemahan Tersimpan</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><div id="saved-list" class="p-4 overflow-y-auto scrollable"></div></div></div>
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Pengaturan</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><div class="p-4 space-y-4"><fieldset><legend class="font-semibold mb-2">Kecepatan Suara</legend><div class="flex gap-4" id="speed-settings"><label><input type="radio" name="speed" value="1" checked> Normal</label><label><input type="radio" name="speed" value="0.7"> Lambat</label><label><input type="radio" name="speed" value="0.4"> Lebih Lambat</label></div></fieldset><fieldset><legend class="font-semibold mb-2">Ukuran Font</legend><div class="flex items-center gap-2"><span class="text-sm">A</span><input id="font-size-slider" type="range" min="12" max="24" value="16" class="w-full"><span class="text-xl">A</span></div></fieldset></div></div></div>
    <div id="ai-style-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Pilih Gaya Penulisan</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><div class="p-4" id="ai-style-options"><div class="grid grid-cols-2 gap-2"><label class="block"><input type="radio" name="ai-style" value="Standar" checked> Standar</label><label class="block"><input type="radio" name="ai-style" value="Sederhana"> Sederhana</label><label class="block"><input type="radio" name="ai-style" value="Profesional"> Profesional</label><label class="block"><input type="radio" name="ai-style" value="Formal"> Formal</label><label class="block"><input type="radio" name="ai-style" value="Akademik"> Akademik</label><label class="block"><input type="radio" name="ai-style" value="Kasual"> Kasual</label></div><button id="apply-style-btn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors">Terapkan Gaya</button></div></div></div>
    <div id="glossary-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Kelola Glosarium</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><div class="p-4 space-y-4"><div class="flex gap-2"><select id="glossary-source-lang" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></select><input id="glossary-source-text" type="text" placeholder="Teks sumber" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div><div class="flex gap-2"><select id="glossary-target-lang" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></select><input id="glossary-target-text" type="text" placeholder="Teks sasaran" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div><button id="add-glossary-btn" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors">Tambah Entri</button></div><div id="glossary-list" class="p-4 overflow-y-auto scrollable border-t dark:border-gray-700"></div></div></div>
    <div id="api-key-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Kelola Kunci API</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><div class="p-4 space-y-4"><p class="text-sm text-slate-600 dark:text-slate-300">Gunakan kunci API dari OpenRouter atau Google AI Studio. <span class="font-semibold">Catatan:</span> Fitur terjemahan Audio üéµ memerlukan kunci API Gemini asli dari Google AI Studio.</p><div><label for="api-provider-select" class="block text-sm font-medium mb-1">Pilih Penyedia AI:</label><select id="api-provider-select" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="gemini">Gemini (via OpenRouter / Google)</option><option value="deepseek">DeepSeek (via OpenRouter)</option><option value="chatgpt">ChatGPT (via OpenRouter)</option></select></div><div><label for="api-key-input" class="block text-sm font-medium mb-1">Kunci API:</label><input id="api-key-input" type="password" placeholder="Masukkan kunci API Gemini Anda" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div><button id="save-api-key-btn" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors">Simpan Kunci</button></div></div></div>
    <div id="correction-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Saran Perbaikan Teks</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><div class="p-4 overflow-y-auto scrollable space-y-4"><div><h4 class="font-semibold mb-2">Teks Asli:</h4><pre id="original-text-correction" class="w-full bg-slate-100 dark:bg-gray-700 rounded-lg p-3 whitespace-pre-wrap font-sans"></pre></div><div><h4 class="font-semibold mb-2">Teks yang Disarankan:</h4><div id="correction-diff" class="w-full bg-slate-100 dark:bg-gray-700 rounded-lg p-3 whitespace-pre-wrap font-sans"></div></div></div><div class="flex justify-end gap-4 p-4 border-t dark:border-gray-700"><button id="reject-correction-btn" class="bg-slate-200 dark:bg-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500 transition-colors">Batal</button><button id="accept-correction-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Terapkan Perbaikan</button></div></div></div>
    <div id="profile-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md max-h-[80vh] flex flex-col"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Profil & Lencana</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><div class="p-6 overflow-y-auto scrollable text-center"><p class="font-semibold" id="profile-email"></p><p class="text-2xl font-bold text-amber-500 my-2" id="profile-points">0 Poin</p><hr class="dark:border-gray-700 my-4"><h4 class="font-semibold mb-4">Lencana Saya</h4><div id="badges-container" class="grid grid-cols-3 sm:grid-cols-4 gap-4"><div class="badge earned text-center" title="Penerjemah Pemula: Selesaikan 10 terjemahan."><div class="text-4xl">üî∞</div><p class="text-xs mt-1">Pemula</p></div><div class="badge text-center" title="Penerjemah Ahli: Selesaikan 100 terjemahan."><div class="text-4xl">‚≠ê</div><p class="text-xs mt-1">Ahli</p></div><div class="badge text-center" title="Korektor Andal: Koreksi 5 teks dengan AI."><div class="text-4xl">‚úçÔ∏è</div><p class="text-xs mt-1">Korektor</p></div><div class="badge text-center" title="Polyglot: Terjemahkan ke 5 bahasa berbeda."><div class="text-4xl">üåê</div><p class="text-xs mt-1">Polyglot</p></div></div></div></div></div>
    <div id="word-of-the-day-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-lg font-semibold">Kata Hari Ini</h3><button class="close-modal-btn text-2xl hover:text-red-500">&times;</button></div><div id="word-of-the-day-content" class="p-6 text-center"></div><div class="p-4 border-t dark:border-gray-700 text-center"><button id="change-word-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Ubah Kata</button><p id="change-word-counter" class="text-xs text-slate-500 mt-2"></p></div></div></div>
    
    <!-- MODAL BARU: Saran Koreksi -->
    <div id="correction-suggestion-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                <h3 class="text-lg font-semibold">Sarankan Perbaikan</h3>
                <button class="close-modal-btn text-2xl hover:text-red-500">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto scrollable space-y-4">
                <div>
                    <h4 class="font-semibold mb-1 text-sm text-slate-500">Teks Asli:</h4>
                    <p id="suggestion-original-text" class="w-full bg-slate-100 dark:bg-gray-700 rounded-lg p-2 text-sm"></p>
                </div>
                <div>
                    <h4 class="font-semibold mb-1 text-sm text-slate-500">Terjemahan Saat Ini:</h4>
                    <p id="suggestion-current-translation" class="w-full bg-slate-100 dark:bg-gray-700 rounded-lg p-2 text-sm"></p>
                </div>
                <div>
                    <label for="suggestion-textarea" class="font-semibold mb-1 text-sm">Saran Anda:</label>
                    <textarea id="suggestion-textarea" rows="4" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-4 p-4 border-t dark:border-gray-700">
                <button id="cancel-suggestion-btn" class="bg-slate-200 dark:bg-gray-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500 transition-colors">Batal</button>
                <button id="submit-suggestion-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Kirim Saran</button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-all duration-300 z-50">Teks disalin!</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. DOM ELEMENTS ---
        const sourceLangEl = document.getElementById('source-lang'), targetLangEl = document.getElementById('target-lang');
        const sourceTextEl = document.getElementById('source-text'), translatedOutput = document.getElementById('translated-output'), romanizationOutput = document.getElementById('romanization-output');
        const charCountEl = document.getElementById('char-count');
        const swapBtn = document.getElementById('swap-btn');
        const notification = document.getElementById('notification');
        const dictionaryResultEl = document.getElementById('dictionary-result');
        const themeMenuButton = document.getElementById('theme-menu-button'), themeMenu = document.getElementById('theme-menu');
        const tabBtns = document.querySelectorAll('.tab-btn'), tabPanels = document.querySelectorAll('.tab-panel');
        const historyBtn = document.getElementById('history-btn'), savedBtn = document.getElementById('saved-btn');
        const historyModal = document.getElementById('history-modal'), savedModal = document.getElementById('saved-modal');
        const historyList = document.getElementById('history-list'), savedList = document.getElementById('saved-list');
        const imageUpload = document.getElementById('image-upload'), ocrStatus = document.getElementById('ocr-status'), ocrProgress = document.getElementById('ocr-progress'), ocrProgressBar = document.getElementById('ocr-progress-bar'), imagePreviewContainer = document.getElementById('image-preview-container'), imageTargetLangEl = document.getElementById('image-target-lang'), imageDropZone = document.getElementById('image-drop-zone'), imageViewport = document.getElementById('image-viewport'), imageTransformer = document.getElementById('image-transformer'), zoomInBtn = document.getElementById('zoom-in-btn'), zoomOutBtn = document.getElementById('zoom-out-btn'), zoomLevelDisplay = document.getElementById('zoom-level-display'), resetViewBtn = document.getElementById('reset-view-btn'), compareToggle = document.getElementById('compare-toggle');
        const docUpload = document.getElementById('doc-upload'), docStatus = document.getElementById('doc-status'), docTextResult = document.getElementById('doc-text-result'), docTargetLangEl = document.getElementById('doc-target-lang'), docDropZone = document.getElementById('doc-drop-zone');
        const saveTranslationBtn = document.getElementById('save-translation-btn');
        const sourceSpeakBtn = document.getElementById('source-speak-btn'), targetSpeakBtn = document.getElementById('target-speak-btn');
        const copyBtn = document.getElementById('copy-btn'), shareBtn = document.getElementById('share-btn'), googleSearchBtn = document.getElementById('google-search-btn');
        const settingsBtn = document.getElementById('settings-btn'), settingsModal = document.getElementById('settings-modal');
        const aiSourceEl = document.getElementById('ai-source'), aiResultEl = document.getElementById('ai-result'), aiChangeStyleBtn = document.getElementById('ai-change-style-btn'), aiStyleModal = document.getElementById('ai-style-modal'), applyStyleBtn = document.getElementById('apply-style-btn');
        const subtitleUpload = document.getElementById('subtitle-upload'), videoTargetLangEl = document.getElementById('video-target-lang'), videoStatusEl = document.getElementById('video-status'), downloadSrtBtn = document.getElementById('download-srt-btn'), subtitleOriginalEl = document.getElementById('subtitle-original'), subtitleTranslatedEl = document.getElementById('subtitle-translated');
        const glossaryToggle = document.getElementById('glossary-toggle'), glossaryManageBtn = document.getElementById('glossary-manage-btn'), glossaryModal = document.getElementById('glossary-modal'), glossarySourceLang = document.getElementById('glossary-source-lang'), glossaryTargetLang = document.getElementById('glossary-target-lang'), glossarySourceText = document.getElementById('glossary-source-text'), glossaryTargetText = document.getElementById('glossary-target-text'), addGlossaryBtn = document.getElementById('add-glossary-btn'), glossaryListEl = document.getElementById('glossary-list');
        const voiceToneSelect = document.getElementById('voice-tone-select');
        const alternativeTranslationsEl = document.getElementById('alternative-translations');
        const apiKeyBtn = document.getElementById('api-key-btn'), apiKeyModal = document.getElementById('api-key-modal'), apiKeyInput = document.getElementById('api-key-input'), saveApiKeyBtn = document.getElementById('save-api-key-btn'),      apiProviderSelect = document.getElementById('api-provider-select');
        const conversationView = document.getElementById('conversation-view'), conversationPlaceholder = document.getElementById('conversation-placeholder');
        const micBtn1 = document.getElementById('mic-btn-1'), micBtn2 = document.getElementById('mic-btn-2');
        const conversationLang1 = document.getElementById('conversation-lang-1'), conversationLang2 = document.getElementById('conversation-lang-2');
        const speechRecognitionUnsupported = document.getElementById('speech-recognition-unsupported');
        const conversationSwapBtn = document.getElementById('conversation-swap-btn');
        const authContainer = document.getElementById('auth-container'), userInfo = document.getElementById('user-info'), userEmailEl = document.getElementById('user-email');
        const loginBtn = document.getElementById('login-btn'), registerBtn = document.getElementById('register-btn'), logoutBtn = document.getElementById('logout-btn');
        const loginModal = document.getElementById('login-modal'), registerModal = document.getElementById('register-modal');
        const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error'), registerError = document.getElementById('register-error');
        const predictiveTextContainer = document.getElementById('predictive-text-container');
        const predictiveTextSuggestion = document.getElementById('predictive-text-suggestion');
        const lyricsTargetLang = document.getElementById('lyrics-target-lang'), lyricsSource = document.getElementById('lyrics-source'), lyricsResult = document.getElementById('lyrics-result'), translateLyricsBtn = document.getElementById('translate-lyrics-btn');
        const codeTargetLang = document.getElementById('code-target-lang'), codeSource = document.getElementById('code-source'), codeResult = document.getElementById('code-result'), translateCodeBtn = document.getElementById('translate-code-btn');
        const audioTargetLang = document.getElementById('audio-target-lang'), audioUpload = document.getElementById('audio-upload'), audioUploadBtn = document.getElementById('audio-upload-btn'), audioDropZone = document.getElementById('audio-drop-zone'), audioTranscribedText = document.getElementById('audio-transcribed-text'), audioTranslatedText = document.getElementById('audio-translated-text'), audioFileName = document.getElementById('audio-file-name');
        const aiDomainSelect = document.getElementById('ai-domain-select');
        const checkGrammarBtn = document.getElementById('check-grammar-btn');
        const correctionModal = document.getElementById('correction-modal');
        const originalTextCorrectionEl = document.getElementById('original-text-correction');
        const correctionDiffEl = document.getElementById('correction-diff');
        const acceptCorrectionBtn = document.getElementById('accept-correction-btn');
        const rejectCorrectionBtn = document.getElementById('reject-correction-btn');
        const profileBtn = document.getElementById('profile-btn');
        const profileModal = document.getElementById('profile-modal');
        const userPointsEl = document.getElementById('user-points');
        const profileEmailEl = document.getElementById('profile-email');
        const profilePointsEl = document.getElementById('profile-points');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const wordOfTheDayBtn = document.getElementById('word-of-the-day-btn');
        const wordOfTheDayModal = document.getElementById('word-of-the-day-modal');
        const wordOfTheDayContent = document.getElementById('word-of-the-day-content');
        const changeWordBtn = document.getElementById('change-word-btn');
        const changeWordCounterEl = document.getElementById('change-word-counter');
        const quizQuestion = document.getElementById('quiz-question');
        const quizOptions = document.getElementById('quiz-options');
        const quizFeedback = document.getElementById('quiz-feedback');
        const nextQuizBtn = document.getElementById('next-quiz-btn');
        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const loginPrompt = document.getElementById('login-prompt');
        const loginPromptBtn = document.getElementById('login-prompt-btn');
        const registerPromptBtn = document.getElementById('register-prompt-btn');
        const bottomButtons = document.getElementById('bottom-buttons');
        // Elemen Fitur Baru: Feedback
        const feedbackContainer = document.getElementById('feedback-container');
        const suggestEditBtn = document.getElementById('suggest-edit-btn');
        const correctionSuggestionModal = document.getElementById('correction-suggestion-modal');
        const suggestionOriginalText = document.getElementById('suggestion-original-text');
        const suggestionCurrentTranslation = document.getElementById('suggestion-current-translation');
        const suggestionTextarea = document.getElementById('suggestion-textarea');
        const submitSuggestionBtn = document.getElementById('submit-suggestion-btn');
        const cancelSuggestionBtn = document.getElementById('cancel-suggestion-btn');
        // Elemen Fitur Baru: Kamera
        const cameraFeed = document.getElementById('camera-feed');
        const cameraCanvas = document.getElementById('camera-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const cameraOcrStatus = document.getElementById('camera-ocr-status');
        const cameraPermissionPrompt = document.getElementById('camera-permission-prompt');
        // Elemen Fitur Baru: Language Partner
        const partnerNativeLang = document.getElementById('partner-native-lang');
        const partnerPracticeLang = document.getElementById('partner-practice-lang');
        const goOnlineBtn = document.getElementById('go-online-btn');
        const goOfflineBtn = document.getElementById('go-offline-btn');
        const partnerList = document.getElementById('partner-list');


        // --- 2. STATE & CONSTANTS ---
        const languages = { "auto": "Deteksi Otomatis", "af": "Afrikaans", "sq": "Albanian", "am": "Amharic", "ar": "Arabic", "hy": "Armenian", "az": "Azerbaijani", "eu": "Basque", "be": "Belarusian", "bn": "Bengali", "bs": "Bosnian", "bg": "Bulgarian", "ca": "Catalan", "ceb": "Cebuano", "ny": "Chichewa", "zh-CN": "Chinese (Simplified)", "zh-TW": "Chinese (Traditional)", "co": "Corsican", "hr": "Croatian", "cs": "Czech", "da": "Danish", "nl": "Dutch", "en": "English", "eo": "Esperanto", "et": "Estonian", "tl": "Filipino", "fi": "Finnish", "fr": "French", "fy": "Frisian", "gl": "Galician", "ka": "Georgian", "de": "German", "el": "Greek", "gu": "Gujarati", "ht": "Haitian Creole", "ha": "Hausa", "haw": "Hawaiian", "iw": "Hebrew", "hi": "Hindi", "hmn": "Hmong", "hu": "Hungarian", "is": "Icelandic", "ig": "Igbo", "id": "Indonesian", "ga": "Irish", "it": "Italian", "ja": "Japanese", "jw": "Javanese", "kn": "Kannada", "kk": "Kazakh", "km": "Khmer", "ko": "Korean", "ku": "Kurdish (Kurmanji)", "ky": "Kyrgyz", "lo": "Lao", "la": "Latin", "lv": "Latvian", "lt": "Lithuanian", "lb": "Luxembourgish", "mk": "Macedonian", "mg": "Malagasy", "ms": "Malay", "ml": "Malayalam", "mt": "Maltese", "mi": "Maori", "mr": "Marathi", "mn": "Mongolian", "my": "Myanmar (Burmese)", "ne": "Nepali", "no": "Norwegian", "ps": "Pashto", "fa": "Persian", "pl": "Polish", "pt": "Portuguese", "pa": "Punjabi", "ro": "Romanian", "ru": "Russian", "sm": "Samoan", "gd": "Scots Gaelic", "sr": "Serbian", "st": "Sesotho", "sn": "Shona", "sd": "Sindhi", "si": "Sinhala", "sk": "Slovak", "sl": "Slovenian", "so": "Somali", "es": "Spanish", "su": "Sundanese", "sw": "Swahili", "sv": "Swedish", "tg": "Tajik", "ta": "Tamil", "te": "Telugu", "th": "Thai", "tr": "Turkish", "uk": "Ukrainian", "ur": "Urdu", "uz": "Uzbek", "vi": "Vietnamese", "cy": "Welsh", "xh": "Xhosa", "yi": "Yiddish", "yo": "Yoruba", "zu": "Zulu" };
        const HISTORY_KEY = 'translation_history', SAVED_KEY = 'translation_saved', GLOSSARY_KEY = 'translation_glossary';
        let currentTranslationData = {};
        let debounceTimer, predictiveDebounceTimer, originalDocText = null, originalSrtSubs = null, translatedSrtContent = null;
        let currentImageSrc = null;
        let zoomState = { level: 1, pan: { x: 0, y: 0 }, isPanning: false, start: { x: 0, y: 0 } };
        let isRecording = false;
        let recognition;
        let activeMicButton = null;
        let currentUser = null;
        let userApiKeys = {};
        let currentAiProvider = 'gemini';
        let correctedText = '';
        let wordChangeCounter = 0;
        const MAX_WORD_CHANGES = 10;
        let currentQuiz = null;
        let quizHistory = [];
        let cameraStream = null;
        let unsubscribeFromPartners = null;
        
        // --- 3. API & CORE FUNCTIONS ---
        async function translate(text, sourceLang, targetLang) {
             if (!text) return ["", "", []];
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&dt=rm&dt=at&q=${encodeURIComponent(text)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                const translatedText = data[0].map(segment => segment[0]).join('');
                let romanization = data[0]?.[data[0].length - 1]?.[2] || "";
                let alternatives = data[5]?.[0]?.[2]?.map(alt => alt[0]) || [];
                return [translatedText, romanization, alternatives];
            } catch (error) {
                console.error('Translation error:', error);
                return ['Terjadi kesalahan saat menerjemahkan.', '', []];
            }
        }

        async function callAiAPI(prompt, filePayload = null) {
            // Pengecualian: Unggahan file (audio) HARUS menggunakan API Google Gemini asli
            // karena format `inlineData` tidak kompatibel dengan endpoint penyedia lain.
            if (filePayload) {
                const geminiApiKey = userApiKeys['gemini'];
                if (!geminiApiKey) {
                    return { error: "Fitur audio memerlukan kunci API Gemini langsung dari Google AI Studio." };
                }
                
                console.log("Using native Google Gemini API for file upload.");
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
                const headers = { 'Content-Type': 'application/json' };
                const body = JSON.stringify({ contents: [{ parts: [{ text: prompt }, filePayload] }] });

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers, body });
                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = errorData.error?.message || 'Unknown error';
                        if (errorMessage.includes('API key not valid')) {
                            return { error: 'Kunci API Gemini tidak valid. Fitur audio memerlukan kunci API dari Google AI Studio, bukan dari penyedia lain.' };
                        }
                        return { error: `Error dari Google API: ${errorMessage}`};
                    }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return { text: result.candidates[0].content.parts[0].text };
                    }
                    return { error: `Permintaan diblokir oleh Google API karena: ${result.promptFeedback?.blockReason || 'alasan tidak diketahui'}.` };
                } catch (error) {
                    return { error: `Gagal menghubungi Google API. Periksa koneksi internet atau kunci API Gemini Anda.` };
                }
            }

            // Untuk semua permintaan berbasis teks, gunakan penyedia yang dipilih
            const provider = currentAiProvider;
            const apiKey = userApiKeys[provider];
            if (!apiKey) {
                return { error: `Kunci API untuk ${provider} belum diatur.` };
            }

            const sourceName = 'OpenRouter';
            const apiUrl = 'https://openrouter.ai/api/v1/chat/completions';
            const siteUrl = window.location.href;
            const siteTitle = document.title;
            const headers = { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${apiKey}`,
                'HTTP-Referer': siteUrl,
                'X-Title': siteTitle
            };
            
            let model;
            switch (provider) {
                case 'deepseek':
                    model = "deepseek/deepseek-chat";
                    break;
                case 'chatgpt':
                    model = "openai/gpt-3.5-turbo";
                    break;
                case 'gemini':
                    model = "google/gemini-pro-1.5";
                    break;
                default:
                    return { error: "Penyedia AI tidak dikenal." };
            }

            const body = JSON.stringify({
                model: model,
                messages: [{ role: "user", content: prompt }]
            });

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers, body });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`API Error for ${provider} via ${sourceName}:`, errorData);
                    const message = errorData.error?.message || JSON.stringify(errorData);
                    let friendlyMessage = message;
                     if (typeof message === 'string') {
                        if (message.includes('insufficient funds') || message.includes('Insufficient Balance')) {
                            friendlyMessage = `Saldo akun ${sourceName} Anda tidak mencukupi. Silakan isi ulang di situs web ${sourceName}.`;
                        } else if (message.includes('exceeded your current quota')) {
                            friendlyMessage = `Kuota API Anda di ${sourceName} telah habis.`;
                        }
                    }
                    return { error: `Error dari ${provider} (${sourceName}): ${friendlyMessage}` };
                }

                const result = await response.json();
                const textResult = result.choices?.[0]?.message?.content;

                if (textResult) {
                    return { text: textResult };
                }
                
                return { error: `Tidak ada respons teks dari ${provider} via ${sourceName}.` };

            } catch (error) {
                console.error(`API call error for ${provider} via ${sourceName}:`, error);
                return { error: `Gagal menghubungi ${sourceName}. Periksa koneksi internet atau kunci API Anda.` };
            }
        }
        
        // --- 4. HELPER & STORAGE FUNCTIONS ---
        const saveToStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const getFromStorage = (key) => JSON.parse(localStorage.getItem(key)) || [];
        function saveToHistory(item) { let history = getFromStorage(HISTORY_KEY); history.unshift(item); if (history.length > 50) history.pop(); saveToStorage(HISTORY_KEY, history); }
        function updateSaveButtonState() { const savedItems = getFromStorage(SAVED_KEY); if (currentTranslationData.id && savedItems.some(item => item.id === currentTranslationData.id)) { saveTranslationBtn.classList.add('saved', 'text-yellow-500'); saveTranslationBtn.title = "Hapus dari simpanan"; } else { saveTranslationBtn.classList.remove('saved', 'text-yellow-500'); saveTranslationBtn.title = "Simpan terjemahan"; } }
        function speak(text, lang, tone = 'standar') { if (!text || !('speechSynthesis' in window)) return; window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); const settings = getVoiceSettings(); utterance.rate = settings.speed; utterance.lang = lang; window.speechSynthesis.speak(utterance); }
        function showNotification(message) { notification.textContent = message; notification.classList.remove('opacity-0'); setTimeout(() => notification.classList.add('opacity-0'), 2500); }
        async function getDefinition(word, lang) { dictionaryResultEl.innerHTML = `Mencari definisi untuk "<b>${word}</b>"...`; dictionaryResultEl.classList.remove('hidden'); try { const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/${lang}/${word}`); if (!response.ok) throw new Error('Definisi tidak ditemukan.'); const data = await response.json(); let content = `<h3>Definisi untuk <b>${data[0].word}</b></h3>`; data[0].meanings.forEach(meaning => { content += `<p class="italic text-slate-500 mt-2">${meaning.partOfSpeech}</p>`; meaning.definitions.forEach((def, i) => { content += `<p class="ml-2">${i + 1}. ${def.definition}</p>`; if(def.example) content += `<p class="ml-4 text-sm text-slate-400">Contoh: "${def.example}"</p>`}); }); dictionaryResultEl.innerHTML = content; } catch (error) { window.open(`https://www.google.com/search?q=arti+${encodeURIComponent(word)}`, '_blank'); dictionaryResultEl.classList.add('hidden'); } }
        function getVoiceSettings() { return { speed: parseFloat(document.querySelector('input[name="speed"]:checked')?.value || 1) }; }
        function saveVoiceSettings() { saveToStorage('voiceSettings', getVoiceSettings()); }
        function loadVoiceSettings() { const settings = getFromStorage('voiceSettings'); if (settings?.speed) { document.querySelector(`input[name="speed"][value="${settings.speed}"]`).checked = true; } }
        function applyGlossary(text, sourceLang, targetLang) { const glossary = getFromStorage(GLOSSARY_KEY); let processedText = text; glossary.forEach(entry => { if (entry.sourceLang === sourceLang && entry.targetLang === targetLang) { const regex = new RegExp(`\\b${entry.sourceText}\\b`, 'gi'); processedText = processedText.replace(regex, entry.targetText); } }); return processedText; }
        function parseSRT(data) { const regex = /(\d+)\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?(?=\n\n|\n*$))/g; let match; const subs = []; while ((match = regex.exec(data)) !== null) { subs.push({ id: match[1], startTime: match[2], endTime: match[3], text: match[4].trim() }); } return subs; }
        function generateSRT(subs) { return subs.map(s => `${s.id}\n${s.startTime} --> ${s.endTime}\n${s.translatedText}`).join('\n\n'); }
        function arrayBufferToBase64(buffer) { let binary = ''; const bytes = new Uint8Array(buffer); for (let i = 0; i < bytes.byteLength; i++) { binary += String.fromCharCode(bytes[i]); } return window.btoa(binary); }
        
        // --- 5. EVENT HANDLERS ---
        async function handleTextTranslation() {
            let sourceText = sourceTextEl.value.trim();
            translatedOutput.innerHTML = '';
            romanizationOutput.innerHTML = '';
            alternativeTranslationsEl.innerHTML = '';
            dictionaryResultEl.classList.add('hidden');
            feedbackContainer.classList.add('hidden');
            if (!sourceText) return;

            if (glossaryToggle.checked) {
                sourceText = applyGlossary(sourceText, sourceLangEl.value, targetLangEl.value);
            }

            translatedOutput.textContent = 'Menerjemahkan...';
            const [translated, romanization, alternatives] = await translate(sourceText, sourceLangEl.value, targetLangEl.value);
            
            currentTranslationData = {
                id: Date.now(),
                sourceLang: sourceLangEl.value,
                targetLang: targetLangEl.value,
                sourceText: sourceTextEl.value.trim(),
                translatedText: translated
            };

            renderMainTranslation(translated);
            if (romanization) romanizationOutput.textContent = romanization;
            if (alternatives?.length > 0) renderAlternatives(alternatives);

            saveToHistory(currentTranslationData);
            updateSaveButtonState();
            renderFeedbackUI();
            logUserActivity('translate_text', { from: sourceLangEl.value, to: targetLangEl.value, length: sourceText.length });
        }
        
        async function fetchPredictiveText() {
            const text = sourceTextEl.value;
            if (!userApiKeys[currentAiProvider] || text.split(' ').length < 3) { predictiveTextSuggestion.textContent = ''; return; }
            const prompt = `Lanjutkan kalimat ini dalam bahasa yang sama dengan beberapa kata saja: "${text}"`;
            const result = await callAiAPI(prompt);
            if (result.text) { predictiveTextSuggestion.textContent = result.text.trim().split('\n')[0]; } else { predictiveTextSuggestion.textContent = ''; }
        }

        async function handleImageTranslation(imageSource, statusElement = ocrStatus) {
            if (!imageSource) return;
            logUserActivity('translate_image');
            resetZoom();
            statusElement.textContent = 'Memuat gambar...';
            if (ocrProgress) ocrProgress.classList.remove('hidden');
            if (ocrProgressBar) ocrProgressBar.style.width = '0%';
            if (imagePreviewContainer) imagePreviewContainer.innerHTML = '';

            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = async () => {
                const originalCanvas = document.createElement('canvas'); originalCanvas.id = 'original-canvas';
                const translatedCanvas = document.createElement('canvas'); translatedCanvas.id = 'translated-canvas';
                [originalCanvas, translatedCanvas].forEach(canvas => { canvas.width = img.width; canvas.height = img.height; canvas.getContext('2d').drawImage(img, 0, 0); });
                if (imagePreviewContainer) {
                    imagePreviewContainer.innerHTML = ''; // Clear previous
                    imagePreviewContainer.append(originalCanvas, translatedCanvas);
                }
                if (compareToggle) compareToggle.checked = false; 
                translatedCanvas.style.visibility = 'visible';
                try {
                    statusElement.textContent = 'Mendeteksi teks...';
                    const { data } = await Tesseract.recognize(img, 'ind+eng', { logger: m => { if (m.status === 'recognizing text' && ocrProgressBar) { statusElement.textContent = `Mendeteksi teks... (${Math.round(m.progress * 100)}%)`; ocrProgressBar.style.width = `${m.progress * 100}%`; } } });
                    if (data.lines.length === 0) { statusElement.textContent = 'Tidak ada teks yang terdeteksi.'; if (ocrProgress) ocrProgress.classList.add('hidden'); return; }
                    statusElement.textContent = `Terdeteksi ${data.lines.length} baris. Menerjemahkan...`;
                    const originalTexts = data.lines.map(line => line.text.trim()).join('\n---\n');
                    const targetLangName = languages[imageTargetLangEl.value] || 'English';
                    const prompt = `Translate the following text lines to ${targetLangName}, considering the full context. Each line is separated by "---". Maintain the exact number of lines and the "---" separator in your response. Provide only the high-quality, natural-sounding translated text.\n\nOriginal text:\n${originalTexts}`;
                    const result = await callAiAPI(prompt);
                    if (result.error) { statusElement.textContent = result.error; return; }
                    const translatedTexts = result.text.split('\n---\n');
                    const translatedCtx = translatedCanvas.getContext('2d');
                    data.lines.forEach((line, index) => {
                        const bbox = line.bbox;
                        const translatedText = translatedTexts[index]?.trim() || '';
                        translatedCtx.fillStyle = 'white'; // Simple fill
                        translatedCtx.fillRect(bbox.x0, bbox.y0, bbox.x1 - bbox.x0, bbox.y1 - bbox.y0);
                        const fittedSize = (bbox.y1 - bbox.y0) * 0.8;
                        translatedCtx.font = `bold ${fittedSize}px 'Inter', sans-serif`;
                        translatedCtx.fillStyle = 'black';
                        translatedCtx.textBaseline = 'middle';
                        translatedCtx.fillText(translatedText, bbox.x0, bbox.y0 + (bbox.y1 - bbox.y0) / 2);
                    });
                    statusElement.textContent = 'Terjemahan gambar selesai!';
                } catch (error) { statusElement.textContent = 'Gagal memproses gambar.'; } finally { if (ocrProgress) ocrProgress.classList.add('hidden'); }
            };
            img.onerror = () => { statusElement.textContent = 'Gagal memuat gambar.'; };
            if (typeof imageSource === 'string') { img.src = imageSource; currentImageSrc = imageSource; } else { const url = URL.createObjectURL(imageSource); img.src = url; currentImageSrc = url; }
        }

        async function handleDocumentUpload(file) { if (!file) return; logUserActivity('translate_document', { type: file.type, size: file.size }); docStatus.textContent = `Membaca file: ${file.name}...`; originalDocText = null; const reader = new FileReader(); reader.onload = async (e) => { const text = e.target.result; originalDocText = text; docStatus.textContent = 'Menerjemahkan konten...'; const [translated] = await translate(text, 'auto', docTargetLangEl.value); docTextResult.textContent = translated; docStatus.textContent = 'Terjemahan dokumen selesai.'; saveToHistory({ id: Date.now(), sourceLang: 'auto', targetLang: docTargetLangEl.value, sourceText: `[Dokumen: ${file.name}]`, translatedText: translated }); }; reader.onerror = () => { docStatus.textContent = 'Gagal membaca file.'; }; reader.readAsText(file); }
        function handleSaveClick() { if (!currentTranslationData.id) return; logUserActivity('save_translation'); let saved = getFromStorage(SAVED_KEY); const isAlreadySaved = saved.some(item => item.id === currentTranslationData.id); if (isAlreadySaved) { saved = saved.filter(item => item.id !== currentTranslationData.id); showNotification("Dihapus dari simpanan."); } else { saved.unshift(currentTranslationData); showNotification("Terjemahan disimpan!"); } saveToStorage(SAVED_KEY, saved); updateSaveButtonState(); }
        async function handleAiAction(action, buttonEl) { 
            const text = aiSourceEl.value.trim(); 
            if (!text) { 
                showNotification("Masukkan teks terlebih dahulu."); 
                return; 
            } 
            if (!userApiKeys[currentAiProvider]) {
                showNotification(`Kunci API untuk ${currentAiProvider} belum diatur.`);
                return;
            }
            logUserActivity('ai_assist', { action: action }); 
            const domain = aiDomainSelect.value; 
            let instruction = action === 'shorten' ? 'ringkas teks berikut' : `ubah gaya tulisan berikut menjadi lebih "${action}"`; 
            const prompt = `Dengan konteks ${domain}, ${instruction}, tanpa mengubah makna aslinya. Berikan hanya hasilnya saja. Teks: "${text}"`; 
            buttonEl.disabled = true; 
            const loader = buttonEl.querySelector('.loader'); 
            loader.classList.remove('hidden'); 
            aiResultEl.value = 'AI sedang berpikir...'; 
            const result = await callAiAPI(prompt); 
            aiResultEl.value = result.text || result.error; 
            buttonEl.disabled = false; 
            loader.classList.add('hidden'); 
        }
        async function handleSubtitleUpload(file) { if (!file) return; logUserActivity('translate_subtitle'); videoStatusEl.textContent = 'Membaca file...'; const srtContent = await file.text(); subtitleOriginalEl.textContent = srtContent; originalSrtSubs = parseSRT(srtContent); await retranslateSubtitles(); }
        async function retranslateSubtitles() { 
            if (!originalSrtSubs) return; 
            if (!userApiKeys[currentAiProvider]) {
                videoStatusEl.textContent = `Error: Kunci API untuk ${currentAiProvider} belum diatur.`;
                return;
            }
            videoStatusEl.textContent = `Menerjemahkan ${originalSrtSubs.length} baris...`; 
            const allText = originalSrtSubs.map(s => s.text).join('\n---\n'); 
            const prompt = `Translate the following subtitle lines to ${languages[videoTargetLangEl.value]}. Maintain the line breaks separated by "---". Provide only the translated text. Text:\n${allText}`; 
            const result = await callAiAPI(prompt); 
            if (result.error) { 
                videoStatusEl.textContent = result.error; 
                return; 
            } 
            let translatedLines = result.text.split('\n---\n'); 
            if (translatedLines.length !== originalSrtSubs.length) { 
                videoStatusEl.textContent = 'Error: AI translation returned unexpected format.'; 
                return; 
            } 
            originalSrtSubs.forEach((sub, index) => { 
                sub.translatedText = translatedLines[index] || sub.text; 
            }); 
            translatedSrtContent = generateSRT(originalSrtSubs); 
            subtitleTranslatedEl.textContent = translatedSrtContent; 
            downloadSrtBtn.classList.remove('hidden'); 
            videoStatusEl.textContent = 'Subtitle siap diunduh!'; 
        }
        function handleDownloadSRT() { if (!translatedSrtContent) return; logUserActivity('download_subtitle'); const blob = new Blob([translatedSrtContent], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'subtitle_terjemahan.srt'; a.click(); URL.revokeObjectURL(url); }
        function handleSwap() { if (sourceLangEl.value === 'auto') { showNotification("Tidak bisa menukar 'Deteksi Otomatis'."); return; } logUserActivity('swap_languages'); const sourceLang = sourceLangEl.value, targetLang = targetLangEl.value, sourceText = sourceTextEl.value, targetText = translatedOutput.textContent; sourceLangEl.value = targetLang; targetLangEl.value = sourceLang; sourceTextEl.value = targetText; handleTextTranslation(); }
        async function handleLyricsTranslation() { 
            if (!userApiKeys[currentAiProvider]) {
                showNotification(`Kunci API untuk ${currentAiProvider} belum diatur.`);
                return;
            }
            const text = lyricsSource.value.trim(); 
            if (!text) { 
                showNotification("Masukkan lirik."); 
                return; 
            } 
            logUserActivity('translate_lyrics'); 
            const prompt = `Translate the following song lyrics to ${languages[lyricsTargetLang.value]}. Maintain the original structure. The translation should be poetic. Lyrics:\n\n${text}`; 
            translateLyricsBtn.disabled = true; 
            lyricsResult.textContent = 'AI sedang menerjemahkan...'; 
            const result = await callAiAPI(prompt); 
            lyricsResult.textContent = result.text || result.error; 
            translateLyricsBtn.disabled = false; 
        }
        async function handleCodeTranslation() { 
             if (!userApiKeys[currentAiProvider]) {
                showNotification(`Kunci API untuk ${currentAiProvider} belum diatur.`);
                return;
            }
            const text = codeSource.value.trim(); 
            if (!text) { 
                showNotification("Masukkan kode."); 
                return; 
            } 
            logUserActivity('translate_code'); 
            const prompt = `Translate only the comments in the following code block to ${languages[codeTargetLang.value]}. Do not change the code itself.\n\nCode:\n\`\`\`\n${text}\n\`\`\``; 
            translateCodeBtn.disabled = true; 
            codeResult.textContent = '// AI sedang menerjemahkan...'; 
            const result = await callAiAPI(prompt); 
            codeResult.textContent = (result.text || result.error).replace(/```/g, ''); 
            translateCodeBtn.disabled = false; 
        }
        async function handleAudioTranslation(file) { 
            if (!file) return;
            const geminiApiKey = userApiKeys.gemini;
            if (!geminiApiKey) {
                showNotification("Fitur audio memerlukan kunci API Gemini dari Google AI Studio.");
                audioTranscribedText.textContent = 'Kunci API Gemini belum diatur. Silakan atur di modal API.';
                return;
            }
            logUserActivity('translate_audio'); 
            audioFileName.textContent = file.name; 
            audioTranscribedText.textContent = 'Membaca file audio...'; 
            audioTranslatedText.textContent = ''; 
            const reader = new FileReader(); 
            reader.onload = async (e) => { 
                const base64Audio = arrayBufferToBase64(e.target.result); 
                const filePayload = { inlineData: { mimeType: file.type, data: base64Audio } }; 
                audioTranscribedText.textContent = 'Mengirim ke AI untuk transkripsi...'; 
                const result = await callAiAPI("Transcribe this audio file accurately.", filePayload); 
                if (result.error) { 
                    audioTranscribedText.textContent = result.error; 
                    return; 
                } 
                audioTranscribedText.textContent = result.text; 
                audioTranslatedText.textContent = 'Menerjemahkan transkripsi...'; 
                const [translatedText] = await translate(result.text, 'auto', audioTargetLang.value); 
                audioTranslatedText.textContent = translatedText; 
            }; 
            reader.onerror = () => { 
                audioTranscribedText.textContent = 'Gagal membaca file audio.'; 
            }; 
            reader.readAsArrayBuffer(file); 
        }
        async function handleGrammarCheck() { 
            if (!userApiKeys[currentAiProvider]) {
                 showNotification(`Kunci API untuk ${currentAiProvider} belum diatur.`);
                return;
            }
            const text = sourceTextEl.value.trim(); 
            if (!text) { 
                showNotification("Masukkan teks."); 
                return; 
            } 
            logUserActivity('check_grammar'); 
            const loader = checkGrammarBtn.querySelector('.loader'); 
            loader.classList.remove('hidden'); 
            checkGrammarBtn.disabled = true; 
            const prompt = `Periksa dan perbaiki kesalahan tata bahasa dan ejaan pada teks berikut. Berikan hanya teks yang sudah diperbaiki saja. Teks: "${text}"`; 
            const result = await callAiAPI(prompt); 
            loader.classList.add('hidden'); 
            checkGrammarBtn.disabled = false; 
            if (result.error) { 
                showNotification(result.error); 
            } else { 
                correctedText = result.text.trim(); 
                originalTextCorrectionEl.textContent = text; 
                const dmp = new diff_match_patch(); 
                const diff = dmp.diff_main(text, correctedText); 
                dmp.diff_cleanup_semantic(diff); 
                correctionDiffEl.innerHTML = dmp.diff_prettyHtml(diff); 
                correctionModal.classList.add('flex'); 
            } 
        }
        async function handleFeedback(rating) {
            if (!currentTranslationData.id || !currentUser) { showNotification("Silakan login untuk memberi feedback."); return; }
            const { db, collection, addDoc, serverTimestamp } = window.firebaseServices;
            try {
                await addDoc(collection(db, "translation_feedback"), {
                    ...currentTranslationData,
                    rating: rating,
                    userId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                showNotification("Terima kasih atas masukan Anda!");
                document.querySelectorAll('.feedback-btn').forEach(btn => btn.classList.remove('selected'));
                document.querySelector(`.feedback-btn[data-rating="${rating}"]`).classList.add('selected');
            } catch (error) {
                console.error("Error submitting feedback:", error);
                showNotification("Gagal mengirim feedback.");
            }
        }
        async function handleSuggestionSubmit() {
            const suggestion = suggestionTextarea.value.trim();
            if (!suggestion || !currentTranslationData.id || !currentUser) { showNotification("Saran tidak boleh kosong."); return; }
            const { db, collection, addDoc, serverTimestamp } = window.firebaseServices;
            try {
                await addDoc(collection(db, "translation_feedback"), {
                    ...currentTranslationData,
                    suggestion: suggestion,
                    userId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                showNotification("Saran Anda telah dikirim. Terima kasih!");
                correctionSuggestionModal.classList.remove('flex');
            } catch (error) {
                console.error("Error submitting suggestion:", error);
                showNotification("Gagal mengirim saran.");
            }
        }

        // --- 6. RENDER & UI FUNCTIONS ---
        function renderMainTranslation(text) { const words = text.split(/(\s+)/); translatedOutput.innerHTML = ''; words.forEach(word => { if (word.trim().length > 0) { const span = document.createElement('span'); span.textContent = word; span.className = 'dict-word'; span.onclick = () => getDefinition(word.trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,""), targetLangEl.value); translatedOutput.appendChild(span); } else { translatedOutput.appendChild(document.createTextNode(word)); } }); }
        function renderAlternatives(alternatives) { alternativeTranslationsEl.innerHTML = '<hr class="my-2 border-slate-200 dark:border-gray-600"><p class="font-semibold text-xs mb-1">Opsi lain:</p>'; alternatives.forEach(alt => { const p = document.createElement('p'); p.textContent = alt; p.className = 'alternative-translation'; p.onclick = () => { renderMainTranslation(alt); let history = getFromStorage(HISTORY_KEY); if (history[0] && history[0].id === currentTranslationData.id) { history[0].translatedText = alt; saveToStorage(HISTORY_KEY, history); } }; alternativeTranslationsEl.appendChild(p); }); }
        function renderList(listContainer, items, type) { listContainer.innerHTML = items.length === 0 ? `<p class="text-slate-500 dark:text-slate-400 text-center">Tidak ada item.</p>` : ''; items.forEach(item => { const isSaved = getFromStorage(SAVED_KEY).some(s => s.id === item.id); const itemEl = document.createElement('div'); itemEl.className = 'p-3 border-b dark:border-gray-700'; let buttons = type === 'history' ? `<button class="action-btn text-blue-500 disabled:text-gray-400" data-action="save" data-id="${item.id}" ${isSaved ? 'disabled' : ''}>${isSaved ? 'Tersimpan' : 'Simpan'}</button><button class="action-btn text-red-500" data-action="delete-history" data-id="${item.id}">Hapus</button>` : `<button class="action-btn text-yellow-500" data-action="unsave" data-id="${item.id}">Hapus Simpanan</button>`; itemEl.innerHTML = `<div class="history-item-content cursor-pointer" data-id="${item.id}"><div class="text-xs text-slate-500 dark:text-slate-400 mb-1">${languages[item.sourceLang] || 'Auto'} &rarr; ${languages[item.targetLang]}</div><p class="font-semibold truncate">${item.sourceText}</p><p class="text-blue-500 dark:text-blue-400 truncate">${item.translatedText}</p></div><div class="flex gap-4 mt-2 text-xs">${buttons}</div>`; listContainer.appendChild(itemEl); }); }
        function loadHistoryItem(id) { const item = getFromStorage(HISTORY_KEY).find(i => i.id === id); if (item) { document.querySelector('.tab-btn[data-tab="text"]').click(); sourceLangEl.value = item.sourceLang; targetLangEl.value = item.targetLang; sourceTextEl.value = item.sourceText; handleTextTranslation(); historyModal.classList.remove('flex'); savedModal.classList.remove('flex'); } }
        function mainListClickHandler(e) { const actionBtn = e.target.closest('.action-btn'); if (actionBtn) { const { action, id } = actionBtn.dataset; let history = getFromStorage(HISTORY_KEY); let saved = getFromStorage(SAVED_KEY); const numericId = parseInt(id, 10); if (action === 'save') { const itemToSave = history.find(item => item.id === numericId); if (itemToSave && !saved.some(s => s.id === numericId)) { saved.unshift(itemToSave); saveToStorage(SAVED_KEY, saved); } } else if (action === 'unsave') { saved = saved.filter(item => item.id !== numericId); saveToStorage(SAVED_KEY, saved); } else if (action === 'delete-history') { history = history.filter(item => item.id !== numericId); saved = saved.filter(item => item.id !== numericId); saveToStorage(HISTORY_KEY, history); saveToStorage(SAVED_KEY, saved); } renderList(historyList, getFromStorage(HISTORY_KEY), 'history'); renderList(savedList, getFromStorage(SAVED_KEY), 'saved'); updateSaveButtonState(); return; } const content = e.target.closest('.history-item-content'); if (content) { loadHistoryItem(parseInt(content.dataset.id, 10)); } }
        function updateView() { imageTransformer.style.transform = `scale(${zoomState.level}) translate(${zoomState.pan.x}px, ${zoomState.pan.y}px)`; zoomLevelDisplay.textContent = `${Math.round(zoomState.level * 100)}%`; }
        function resetZoom() { zoomState = { level: 1, pan: { x: 0, y: 0 }, isPanning: false, start: { x: 0, y: 0 } }; updateView(); }
        function addConversationBubble(sourceText, translatedText, sourceLang) { conversationPlaceholder.classList.add('hidden'); const bubble = document.createElement('div'); const isLang1 = sourceLang === conversationLang1.value || (sourceLang === 'auto' && activeMicButton.id === 'mic-btn-1'); bubble.className = `w-full flex mb-2 ${isLang1 ? 'justify-end' : 'justify-start'}`; bubble.innerHTML = `<div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-lg ${isLang1 ? 'bg-blue-500 text-white' : 'bg-slate-200 dark:bg-gray-700'}"><p class="font-semibold">${sourceText}</p><p class="text-sm opacity-90 mt-1">${translatedText}</p></div>`; conversationView.appendChild(bubble); conversationView.scrollTop = conversationView.scrollHeight; }
        function renderFeedbackUI() { feedbackContainer.classList.remove('hidden'); document.querySelectorAll('.feedback-btn').forEach(btn => btn.classList.remove('selected')); }

        // --- 7. FITUR BARU & INITIALIZATION ---
        async function logUserActivity(activityType, metadata = {}) {
            if (!currentUser) return; // Hanya lacak pengguna yang login
            const { db, collection, addDoc, serverTimestamp } = window.firebaseServices;
            try {
                await addDoc(collection(db, "user_activity"), {
                    userId: currentUser.uid,
                    activity: activityType,
                    timestamp: serverTimestamp(),
                    details: metadata,
                    ab_test_group: localStorage.getItem('ab_test_group') || 'A' // Melacak grup A/B test
                });
            } catch (error) {
                console.error("Error logging activity:", error);
            }
        }

        function initializeABTesting() {
            let group = localStorage.getItem('ab_test_group');
            if (!group) {
                group = Math.random() < 0.5 ? 'A' : 'B';
                localStorage.setItem('ab_test_group', group);
            }
            // Contoh sederhana A/B Test: mengubah warna tombol register
            if (group === 'B') {
                registerBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                registerBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
            console.log(`User is in A/B Test Group: ${group}`);
        }

        async function startCamera() {
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                cameraFeed.srcObject = cameraStream;
                cameraPermissionPrompt.classList.add('hidden');
            } catch (err) {
                console.error("Error accessing camera:", err);
                cameraPermissionPrompt.classList.remove('hidden');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        function handleCapture() {
            if (!cameraStream) { showNotification("Kamera tidak aktif."); return; }
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraFeed.videoWidth;
            cameraCanvas.height = cameraFeed.videoHeight;
            context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
            cameraCanvas.toBlob(blob => {
                handleImageTranslation(blob, cameraOcrStatus);
            });
        }

        async function goOnlineAsPartner() {
            if (!currentUser) { showNotification("Login untuk menjadi partner."); return; }
            const { db, doc, setDoc } = window.firebaseServices;
            const nativeLang = partnerNativeLang.value;
            const practiceLang = partnerPracticeLang.value;
            goOnlineBtn.disabled = true;
            try {
                await setDoc(doc(db, "language_partners", currentUser.uid), {
                    email: currentUser.email,
                    native: nativeLang,
                    practicing: practiceLang,
                    online: true
                });
                goOnlineBtn.classList.add('hidden');
                goOfflineBtn.classList.remove('hidden');
                showNotification("Anda sekarang online sebagai partner!");
                listenForPartners();
            } catch (e) { console.error(e); showNotification("Gagal untuk online."); goOnlineBtn.disabled = false; }
        }

        async function goOfflineAsPartner() {
            if (!currentUser) return;
            const { db, doc, deleteDoc } = window.firebaseServices;
            goOfflineBtn.disabled = true;
            try {
                await deleteDoc(doc(db, "language_partners", currentUser.uid));
                goOfflineBtn.classList.add('hidden');
                goOnlineBtn.classList.remove('hidden');
                showNotification("Anda sekarang offline.");
                if (unsubscribeFromPartners) unsubscribeFromPartners();
            } catch (e) { console.error(e); showNotification("Gagal untuk offline."); goOfflineBtn.disabled = false; }
        }

        function listenForPartners() {
            if (unsubscribeFromPartners) unsubscribeFromPartners(); // Hentikan listener sebelumnya
            const { db, collection, onSnapshot } = window.firebaseServices;
            const q = collection(db, "language_partners");
            unsubscribeFromPartners = onSnapshot(q, (querySnapshot) => {
                const partners = [];
                querySnapshot.forEach((doc) => {
                    // Jangan tampilkan diri sendiri
                    if (doc.id !== currentUser?.uid) {
                        partners.push({ id: doc.id, ...doc.data() });
                    }
                });
                renderPartnerList(partners);
            });
        }

        function renderPartnerList(partners) {
            partnerList.innerHTML = '';
            if (partners.length === 0) {
                partnerList.innerHTML = '<p class="text-slate-400 text-center p-4">Tidak ada partner yang online saat ini.</p>';
                return;
            }
            partners.forEach(p => {
                const partnerEl = document.createElement('div');
                partnerEl.className = 'p-2 border-b dark:border-gray-600 flex justify-between items-center';
                partnerEl.innerHTML = `
                    <div>
                        <p class="font-semibold text-sm">${p.email.split('@')[0]}</p>
                        <p class="text-xs text-slate-500">Native: ${languages[p.native] || p.native}, Latihan: ${languages[p.practicing] || p.practicing}</p>
                    </div>
                    <button class="bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-600">Hubungi</button>
                `;
                partnerEl.querySelector('button').onclick = () => {
                    logUserActivity('connect_language_partner');
                    alert(`Simulasi menghubungkan dengan ${p.email}... Fitur chat/video call akan diimplementasikan di sini.`);
                };
                partnerList.appendChild(partnerEl);
            });
        }


        function initializeSpeechRecognition() { const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; if (!SpeechRecognition) { speechRecognitionUnsupported.classList.remove('hidden'); micBtn1.disabled = true; micBtn2.disabled = true; return; } recognition = new SpeechRecognition(); recognition.continuous = false; recognition.interimResults = true; recognition.onstart = () => { isRecording = true; if(activeMicButton) activeMicButton.classList.add('recording', 'pulse-red'); }; recognition.onend = () => { isRecording = false; if(activeMicButton) activeMicButton.classList.remove('recording', 'pulse-red'); activeMicButton = null; }; recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); if(activeMicButton) activeMicButton.classList.remove('recording', 'pulse-red'); }; recognition.onresult = async (event) => { let finalTranscript = ''; for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript; } if (finalTranscript && activeMicButton) { const sourceLang = document.getElementById(activeMicButton.dataset.langSelect).value; const targetLang = activeMicButton.id === 'mic-btn-1' ? conversationLang2.value : conversationLang1.value; const [translated] = await translate(finalTranscript, sourceLang, targetLang); addConversationBubble(finalTranscript, translated, sourceLang); speak(translated, targetLang); saveToHistory({ id: Date.now(), sourceLang, targetLang, sourceText: `[Percakapan] ${finalTranscript}`, translatedText: translated }); logUserActivity('translate_voice'); } }; }
        window.setupAuthUI = async (user) => { if (user) { currentUser = user; authContainer.classList.add('hidden'); userInfo.classList.remove('hidden'); userInfo.classList.add('flex'); userEmailEl.textContent = user.email; loginPrompt.classList.add('hidden'); mainContentWrapper.classList.remove('hidden'); bottomButtons.classList.remove('hidden'); bottomButtons.classList.add('flex'); await getApiKeyFromFirestore(user.uid); await getUserProfile(user.uid); } else { currentUser = null; userApiKeys = {}; quizHistory = []; authContainer.classList.remove('hidden'); userInfo.classList.add('hidden'); userEmailEl.textContent = ''; loginPrompt.classList.remove('hidden'); mainContentWrapper.classList.add('hidden'); bottomButtons.classList.add('hidden'); bottomButtons.classList.remove('flex'); goOfflineAsPartner(); } }
        async function getApiKeyFromFirestore(userId) { const { db, doc, getDoc } = window.firebaseServices; try { const docSnap = await getDoc(doc(db, 'users', userId)); if (docSnap.exists() && docSnap.data().apiKeys) { userApiKeys = docSnap.data().apiKeys; } else { userApiKeys = {}; } } catch (error) { console.error("Error getting API key:", error); userApiKeys = {}; } }
        async function saveApiKeyToFirestore(userId, provider, apiKey) { const { db, doc, setDoc } = window.firebaseServices; try { if (!userApiKeys) userApiKeys = {}; userApiKeys[provider] = apiKey; await setDoc(doc(db, 'users', userId), { apiKeys: userApiKeys }, { merge: true }); showNotification('Kunci API berhasil disimpan!'); } catch (error) { showNotification('Gagal menyimpan kunci API.'); } }
        async function getUserProfile(userId) { const { db, doc, getDoc, setDoc } = window.firebaseServices; try { const docSnap = await getDoc(doc(db, 'users', userId)); if (docSnap.exists()) { const data = docSnap.data(); const points = data.points || 0; userPointsEl.textContent = points; profilePointsEl.textContent = `${points} Poin`; profileEmailEl.textContent = currentUser.email; } else { await setDoc(doc(db, 'users', userId), { email: currentUser.email, points: 0, badges: [] }); } } catch (error) { console.error("Error getting user profile:", error); } }
        async function showWordOfTheDay() { 
            wordOfTheDayContent.innerHTML = '<div class="loader"></div>'; 
            changeWordBtn.disabled = true; 
            const prompt = "Berikan satu kutipan inspiratif singkat dari seorang tokoh terkenal. Format respons sebagai JSON dengan kunci 'quote' dan 'author'."; 
            const result = await callAiAPI(prompt); 
            changeWordBtn.disabled = false; 
            if (result.text) { 
                try { 
                    const jsonMatch = result.text.match(/{[\s\S]*}/); 
                    const data = JSON.parse(jsonMatch[0]); 
                    wordOfTheDayContent.innerHTML = `<p class="text-lg italic text-slate-600 dark:text-slate-300">"${data.quote}"</p><p class="text-md font-semibold mt-4">- ${data.author}</p>`; 
                } catch (e) { 
                    wordOfTheDayContent.textContent = "Gagal memformat kutipan dari AI."; 
                } 
            } else { 
                wordOfTheDayContent.textContent = result.error || "Gagal mengambil kutipan."; 
            } 
        }
        async function generateQuiz(retryCount = 0) {
            logUserActivity('start_quiz');
            quizQuestion.innerHTML = '<div class="loader"></div>';
            quizOptions.innerHTML = '';
            quizFeedback.textContent = '';
            nextQuizBtn.classList.add('hidden');

            if (retryCount > 5) { // Batas percobaan untuk menghindari loop tak terbatas
                quizQuestion.textContent = "Gagal mendapatkan pertanyaan baru dari AI. Coba lagi nanti.";
                return;
            }

            const prompt = "Buat satu pertanyaan kuis pilihan ganda tentang bahasa atau terjemahan. Berikan 4 pilihan jawaban. Format respons sebagai JSON dengan kunci: 'question', 'options' (array), dan 'answer' (string). Pastikan pertanyaannya unik.";
            const result = await callAiAPI(prompt);

            if (result.text) {
                try {
                    const jsonMatch = result.text.match(/{[\s\S]*}/);
                    const newQuiz = JSON.parse(jsonMatch[0]);

                    // Periksa apakah pertanyaan sudah pernah muncul
                    if (quizHistory.includes(newQuiz.question)) {
                        console.log("Pertanyaan duplikat ditemukan, mencoba lagi...");
                        generateQuiz(retryCount + 1); // Panggil lagi untuk pertanyaan baru
                        return;
                    }

                    // Jika pertanyaan unik, lanjutkan
                    currentQuiz = newQuiz;
                    quizHistory.push(currentQuiz.question); // Simpan pertanyaan ke histori sesi

                    quizQuestion.textContent = currentQuiz.question;
                    currentQuiz.options.forEach(optionText => {
                        const button = document.createElement('button');
                        button.textContent = optionText;
                        button.className = 'quiz-option w-full p-2 border rounded-lg dark:border-gray-600 hover:bg-slate-100 dark:hover:bg-gray-700';
                        button.onclick = () => checkQuizAnswer(button, optionText, currentQuiz.answer);
                        quizOptions.appendChild(button);
                    });
                } catch (e) {
                    console.error("Gagal memformat JSON kuis, mencoba lagi...", e);
                    setTimeout(() => generateQuiz(retryCount + 1), 1000); // Coba lagi jika format JSON salah
                }
            } else {
                quizQuestion.textContent = result.error || "Gagal membuat kuis.";
            }
        }
        function checkQuizAnswer(button, selected, correct) { document.querySelectorAll('.quiz-option').forEach(btn => btn.disabled = true); if (selected === correct) { button.classList.add('correct'); quizFeedback.textContent = 'Jawaban Benar! üéâ'; quizFeedback.className = 'mt-4 text-center font-semibold text-green-600'; } else { button.classList.add('incorrect'); quizFeedback.textContent = `Salah. Jawaban yang benar adalah "${correct}".`; quizFeedback.className = 'mt-4 text-center font-semibold text-red-600'; } nextQuizBtn.classList.remove('hidden'); }
        
        function loadAiProviderPreference() {
            const savedProvider = localStorage.getItem('ai_provider');
            if (savedProvider && ['gemini', 'deepseek', 'chatgpt'].includes(savedProvider)) {
                currentAiProvider = savedProvider;
            }
            apiProviderSelect.value = currentAiProvider;
        }

        // Initialize
        const sortedLanguages = Object.entries(languages).filter(([code]) => code !== 'auto').sort(([, nameA], [, nameB]) => nameA.localeCompare(nameB));
        const autoOption = document.createElement('option'); autoOption.value = 'auto'; autoOption.textContent = 'Deteksi Otomatis'; 
        sourceLangEl.appendChild(autoOption.cloneNode(true)); conversationLang1.appendChild(autoOption.cloneNode(true));
        const allSelects = [targetLangEl, docTargetLangEl, imageTargetLangEl, videoTargetLangEl, glossarySourceLang, glossaryTargetLang, conversationLang1, conversationLang2, lyricsTargetLang, codeTargetLang, audioTargetLang, partnerNativeLang, partnerPracticeLang];
        sortedLanguages.forEach(([code, name]) => { const option = document.createElement('option'); option.value = code; option.textContent = name; sourceLangEl.appendChild(option.cloneNode(true)); allSelects.forEach(sel => { if (sel.id === 'conversation-lang-1' && sel.querySelector('option[value="auto"]')) sel.appendChild(option.cloneNode(true)); else if (sel.id !== 'conversation-lang-1') sel.appendChild(option.cloneNode(true)); }); });
        sourceLangEl.value = 'auto'; targetLangEl.value = 'id'; docTargetLangEl.value = 'id'; imageTargetLangEl.value = 'en'; videoTargetLangEl.value = 'id'; glossarySourceLang.value = 'id'; glossaryTargetLang.value = 'en'; conversationLang1.value = 'auto'; conversationLang2.value = 'ja'; lyricsTargetLang.value = 'id'; codeTargetLang.value = 'en'; audioTargetLang.value = 'id'; partnerNativeLang.value = 'id'; partnerPracticeLang.value = 'en';
        loadVoiceSettings(); 
        initializeSpeechRecognition(); 
        initializeABTesting();
        loadAiProviderPreference();
        speechSynthesis.onvoiceschanged = () => { speechSynthesis.getVoices(); };
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
        handleImageTranslation('[https://placehold.co/800x400/e2e8f0/64748b?text=Pilih+Gambar+Anda](https://placehold.co/800x400/e2e8f0/64748b?text=Pilih+Gambar+Anda)');

        // --- Event Listeners ---
        sourceTextEl.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(handleTextTranslation, 500); charCountEl.textContent = `${sourceTextEl.value.length} / 5.000`; clearTimeout(predictiveDebounceTimer); predictiveDebounceTimer = setTimeout(fetchPredictiveText, 500); });
        targetLangEl.addEventListener('change', handleTextTranslation);
        swapBtn.addEventListener('click', handleSwap);
        saveTranslationBtn.addEventListener('click', handleSaveClick);
        sourceSpeakBtn.addEventListener('click', () => speak(sourceTextEl.value, sourceLangEl.value));
        targetSpeakBtn.addEventListener('click', () => speak(translatedOutput.textContent, targetLangEl.value, voiceToneSelect.value));
        copyBtn.addEventListener('click', () => { if(translatedOutput.textContent) { navigator.clipboard.writeText(translatedOutput.textContent).then(() => showNotification('Teks disalin!'), () => showNotification('Gagal menyalin.')); }});
        googleSearchBtn.addEventListener('click', () => { if(translatedOutput.textContent) window.open(`https://www.google.com/search?q=${encodeURIComponent(translatedOutput.textContent)}`, '_blank')});
        shareBtn.addEventListener('click', async () => { if (navigator.share && translatedOutput.textContent) { try { await navigator.share({ title: 'Terjemahan', text: translatedOutput.textContent }); } catch (err) { showNotification('Gagal membagikan.'); } } else { showNotification('Fitur bagikan tidak didukung.'); } });
        themeMenuButton.addEventListener('click', () => themeMenu.classList.toggle('hidden'));
        document.addEventListener('click', e => { if (!themeMenuButton.contains(e.target) && !themeMenu.contains(e.target)) themeMenu.classList.add('hidden'); });
        themeMenu.addEventListener('click', e => { e.preventDefault(); const theme = e.target.dataset.theme; if (theme) { localStorage.setItem('theme', theme); applyTheme(); themeMenu.classList.add('hidden'); } });
        tabBtns.forEach(btn => btn.addEventListener('click', (e) => { if(btn.disabled) return; logUserActivity('change_tab', { tab: btn.dataset.tab }); tabBtns.forEach(b => { b.classList.remove('tab-active', 'text-slate-500', 'dark:text-slate-400'); if(b === btn) b.classList.add('tab-active'); else b.classList.add('text-slate-500', 'dark:text-slate-400'); }); tabPanels.forEach(p => p.classList.add('hidden')); document.getElementById(`${btn.dataset.tab}-panel`).classList.remove('hidden'); if (btn.dataset.tab === 'quiz') generateQuiz(); if (btn.dataset.tab === 'camera') startCamera(); else stopCamera(); if (btn.dataset.tab === 'partner' && currentUser) listenForPartners(); else if (unsubscribeFromPartners) unsubscribeFromPartners(); }));
        historyBtn.addEventListener('click', () => { renderList(historyList, getFromStorage(HISTORY_KEY), 'history'); historyModal.classList.add('flex'); });
        savedBtn.addEventListener('click', () => { renderList(savedList, getFromStorage(SAVED_KEY), 'saved'); savedModal.classList.add('flex'); });
        settingsBtn.addEventListener('click', () => settingsModal.classList.add('flex'));
        
        const apiPlaceholders = {
            gemini: "Kunci dari OpenRouter / Google AI Studio",
            deepseek: "Kunci dari OpenRouter",
            chatgpt: "Kunci dari OpenRouter"
        };

        apiProviderSelect.addEventListener('change', () => {
            const provider = apiProviderSelect.value;
            currentAiProvider = provider;
            localStorage.setItem('ai_provider', provider);
            apiKeyInput.value = userApiKeys[provider] || '';
            apiKeyInput.placeholder = apiPlaceholders[provider] || 'Masukkan kunci API Anda';
        });

        apiKeyBtn.addEventListener('click', () => {
            const provider = apiProviderSelect.value;
            apiKeyInput.value = userApiKeys[provider] || '';
            apiKeyInput.placeholder = apiPlaceholders[provider] || 'Masukkan kunci API Anda';
            apiKeyModal.classList.add('flex');
        });

        saveApiKeyBtn.addEventListener('click', async () => {
            const key = apiKeyInput.value.trim();
            const provider = apiProviderSelect.value;
            if (key) {
                if (currentUser) {
                    await saveApiKeyToFirestore(currentUser.uid, provider, key);
                } else {
                    userApiKeys[provider] = key;
                    showNotification(`Kunci API ${provider} disimpan untuk sesi ini!`);
                }
                apiKeyModal.classList.remove('flex');
            } else {
                if (currentUser) {
                    await saveApiKeyToFirestore(currentUser.uid, provider, '');
                } else {
                    delete userApiKeys[provider];
                }
                showNotification(`Kunci API ${provider} dihapus.`);
                apiKeyInput.value = '';
                apiKeyModal.classList.remove('flex');
            }
        });

        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal').classList.remove('flex')));
        historyList.addEventListener('click', mainListClickHandler);
        savedList.addEventListener('click', mainListClickHandler);
        imageUpload.addEventListener('change', (e) => handleImageTranslation(e.target.files[0]));
        docUpload.addEventListener('change', (e) => handleDocumentUpload(e.target.files[0]));
        audioUpload.addEventListener('change', (e) => handleAudioTranslation(e.target.files[0]));
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => [imageDropZone, docDropZone, audioDropZone].forEach(zone => zone.addEventListener(evt, e => e.preventDefault())));
        ['dragenter', 'dragover'].forEach(evt => [imageDropZone, docDropZone, audioDropZone].forEach(zone => zone.addEventListener(evt, () => zone.classList.add('dragover'))));
        ['dragleave', 'drop'].forEach(evt => [imageDropZone, docDropZone, audioDropZone].forEach(zone => zone.addEventListener(evt, () => zone.classList.remove('dragover'))));
        imageDropZone.addEventListener('drop', e => handleImageTranslation(e.dataTransfer.files[0]));
        docDropZone.addEventListener('drop', e => handleDocumentUpload(e.dataTransfer.files[0]));
        audioDropZone.addEventListener('drop', e => handleAudioTranslation(e.dataTransfer.files[0]));
        audioUploadBtn.addEventListener('click', () => audioUpload.click());
        audioDropZone.addEventListener('click', (e) => { if(e.target === audioDropZone) audioUpload.click(); });
        zoomInBtn.addEventListener('click', () => { zoomState.level = Math.min(4, zoomState.level + 0.25); updateView(); });
        zoomOutBtn.addEventListener('click', () => { zoomState.level = Math.max(1, zoomState.level - 0.25); updateView(); });
        resetViewBtn.addEventListener('click', resetZoom);
        compareToggle.addEventListener('change', (e) => { const canvas = document.getElementById('translated-canvas'); if (canvas) canvas.style.visibility = e.target.checked ? 'hidden' : 'visible'; });
        imageViewport.addEventListener('mousedown', (e) => { e.preventDefault(); zoomState.isPanning = true; zoomState.start = { x: e.clientX - zoomState.pan.x, y: e.clientY - zoomState.pan.y }; });
        imageViewport.addEventListener('mousemove', (e) => { if (zoomState.isPanning) { e.preventDefault(); zoomState.pan.x = e.clientX - zoomState.start.x; zoomState.pan.y = e.clientY - zoomState.start.y; updateView(); } });
        imageViewport.addEventListener('mouseup', () => zoomState.isPanning = false);
        imageViewport.addEventListener('mouseleave', () => zoomState.isPanning = false);
        imageTargetLangEl.addEventListener('change', () => handleImageTranslation(currentImageSrc));
        docTargetLangEl.addEventListener('change', async () => { if (originalDocText) { docStatus.textContent = `Menerjemahkan ulang...`; const [translated] = await translate(originalDocText, 'auto', docTargetLangEl.value); docTextResult.textContent = translated; docStatus.textContent = 'Selesai.'; } });
        document.getElementById('speed-settings').addEventListener('change', saveVoiceSettings);
        document.querySelectorAll('.ai-action-btn').forEach(btn => btn.addEventListener('click', (e) => handleAiAction(e.currentTarget.dataset.action, e.currentTarget)));
        aiChangeStyleBtn.addEventListener('click', () => aiStyleModal.classList.add('flex'));
        applyStyleBtn.addEventListener('click', () => { const selectedStyle = document.querySelector('input[name="ai-style"]:checked').value; handleAiAction(selectedStyle, aiChangeStyleBtn); aiStyleModal.classList.remove('flex'); });
        subtitleUpload.addEventListener('change', e => handleSubtitleUpload(e.target.files[0]));
        downloadSrtBtn.addEventListener('click', handleDownloadSRT);
        videoTargetLangEl.addEventListener('change', retranslateSubtitles);
        glossaryToggle.addEventListener('change', () => { glossaryManageBtn.classList.toggle('hidden', !glossaryToggle.checked); handleTextTranslation(); });
        glossaryManageBtn.addEventListener('click', () => { renderGlossary(); glossaryModal.classList.add('flex'); });
        addGlossaryBtn.addEventListener('click', () => { const sourceText = glossarySourceText.value.trim(), targetText = glossaryTargetText.value.trim(); if (!sourceText || !targetText) return; let glossary = getFromStorage(GLOSSARY_KEY); glossary.push({ sourceLang: glossarySourceLang.value, targetLang: glossaryTargetLang.value, sourceText, targetText }); saveToStorage(GLOSSARY_KEY, glossary); renderGlossary(); glossarySourceText.value = ''; glossaryTargetText.value = ''; });
        glossaryListEl.addEventListener('click', e => { if (e.target.classList.contains('delete-glossary-btn')) { let glossary = getFromStorage(GLOSSARY_KEY); glossary.splice(e.target.dataset.index, 1); saveToStorage(GLOSSARY_KEY, glossary); } });
        [micBtn1, micBtn2].forEach(btn => btn.addEventListener('click', () => { if (isRecording) { recognition.stop(); } else if (recognition) { recognition.lang = document.getElementById(btn.dataset.langSelect).value; activeMicButton = btn; recognition.start(); } }));
        conversationSwapBtn.addEventListener('click', () => { const lang1 = conversationLang1.value, lang2 = conversationLang2.value; if (lang1 === 'auto') { conversationLang1.value = lang2; conversationLang2.value = 'id'; } else { conversationLang1.value = lang2; conversationLang2.value = lang1; } });
        loginBtn.addEventListener('click', () => loginModal.classList.add('flex'));
        registerBtn.addEventListener('click', () => registerModal.classList.add('flex'));
        loginPromptBtn.addEventListener('click', () => loginModal.classList.add('flex'));
        registerPromptBtn.addEventListener('click', () => registerModal.classList.add('flex'));
        logoutBtn.addEventListener('click', () => window.signOut(window.firebaseServices.auth));
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); try { await window.signInWithEmailAndPassword(window.firebaseServices.auth, loginForm['login-email'].value, loginForm['login-password'].value); loginModal.classList.remove('flex'); loginForm.reset(); loginError.textContent = ''; } catch (error) { loginError.textContent = error.message; } });
        registerForm.addEventListener('submit', async (e) => { e.preventDefault(); try { await window.createUserWithEmailAndPassword(window.firebaseServices.auth, registerForm['register-email'].value, registerForm['register-password'].value); registerModal.classList.remove('flex'); registerForm.reset(); registerError.textContent = ''; showNotification('Akun berhasil dibuat!'); } catch (error) { registerError.textContent = error.message; } });
        fontSizeSlider.addEventListener('input', (e) => { const fontSize = e.target.value + 'px'; document.body.style.fontSize = fontSize; localStorage.setItem('fontSize', fontSize); });
        const savedFontSize = localStorage.getItem('fontSize'); if (savedFontSize) { document.body.style.fontSize = savedFontSize; fontSizeSlider.value = parseInt(savedFontSize, 10); }
        wordOfTheDayBtn.addEventListener('click', () => { wordChangeCounter = 0; wordOfTheDayModal.classList.add('flex'); showWordOfTheDay(); });
        changeWordBtn.addEventListener('click', () => { if (wordChangeCounter < MAX_WORD_CHANGES) { wordChangeCounter++; showWordOfTheDay(); } });
        nextQuizBtn.addEventListener('click', generateQuiz);
        translateLyricsBtn.addEventListener('click', handleLyricsTranslation);
        translateCodeBtn.addEventListener('click', handleCodeTranslation);
        checkGrammarBtn.addEventListener('click', handleGrammarCheck);
        acceptCorrectionBtn.addEventListener('click', () => { sourceTextEl.value = correctedText; correctionModal.classList.remove('flex'); handleTextTranslation(); });
        rejectCorrectionBtn.addEventListener('click', () => correctionModal.classList.remove('flex'));
        profileBtn.addEventListener('click', () => profileModal.classList.add('flex'));
        // Event Listeners untuk Feedback
        feedbackContainer.addEventListener('click', (e) => { const btn = e.target.closest('.feedback-btn'); if(btn) handleFeedback(btn.dataset.rating); });
        suggestEditBtn.addEventListener('click', () => { suggestionOriginalText.textContent = currentTranslationData.sourceText; suggestionCurrentTranslation.textContent = currentTranslationData.translatedText; suggestionTextarea.value = currentTranslationData.translatedText; correctionSuggestionModal.classList.add('flex'); });
        submitSuggestionBtn.addEventListener('click', handleSuggestionSubmit);
        cancelSuggestionBtn.addEventListener('click', () => correctionSuggestionModal.classList.remove('flex'));
        // Event Listeners untuk Fitur Baru
        captureBtn.addEventListener('click', handleCapture);
        goOnlineBtn.addEventListener('click', goOnlineAsPartner);
        goOfflineBtn.addEventListener('click', goOfflineAsPartner);
    });
    </script>
</body>
</html>

